<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Final Third</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --green: #2ea043; --gold: #d29922; --red: #da3633; --purple: #a371f7; --blue: #1f6feb; --text: #c9d1d9; --cyan: #3fb950; }
        body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 16px; padding-bottom: 120px; }
        header { border-bottom: 1px solid #30363d; padding-bottom: 15px; margin-bottom: 15px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.4rem; color: var(--blue); display: flex; align-items: center; gap: 10px; }
        .api-badge { background: #21262d; border: 1px solid #30363d; color: #8b949e; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .help-btn { background: #21262d; border: 1px solid #30363d; color: var(--gold); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; }
        .pilot-btn { background: #21262d; border: 1px solid #30363d; color: #888; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .pilot-btn.active { background: rgba(46, 160, 67, 0.2); border-color: var(--green); color: var(--green); }
        .pilot-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .pilot-btn.active .pilot-dot { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .nav-tabs { display: flex; gap: 8px; margin-top: 15px; overflow-x: auto; }
        .nav-tab { flex: 1; text-align: center; padding: 10px; background: #21262d; border-radius: 8px; border: 1px solid #30363d; color: #888; cursor: pointer; font-size: 0.85rem; white-space: nowrap; }
        .nav-tab.active { background: var(--blue); color: white; border-color: var(--blue); }
        select { width: 100%; padding: 12px; background: #21262d; color: white; border: 1px solid #30363d; border-radius: 8px; margin-top: 10px; appearance: none; }
        .chip-container { display: flex; gap: 8px; overflow-x: auto; margin: 15px 0; scrollbar-width: none; }
        .chip { padding: 6px 12px; border-radius: 20px; background: #21262d; border: 1px solid #30363d; color: #888; font-size: 0.8rem; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .chip.active { background: #d29922; color: #0d1117; border-color: #d29922; }
        .match-card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; }
        .score-row { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
        .score-box { background: #21262d; padding: 8px 14px; border-radius: 8px; font-family: monospace; font-weight: bold; }
        .team-name { font-size: 1rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .rank-on-card { color: var(--gold); font-size: 0.8rem; font-family: monospace; }
        .analysis-box { background: #1c1c1c; border: 1px solid var(--purple); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .bet365-btn { flex: 1; background: #00703c; color: white; padding: 10px; border-radius: 8px; text-align: center; text-decoration: none; font-weight: bold; }
        .mark-btn { background: #21262d; border: 1px solid #30363d; color: #888; border-radius: 8px; padding: 0 15px; cursor: pointer; }
        .mark-btn.active { background: var(--green); color: white; }
        .scan-btn { position: fixed; bottom: 30px; left: 5%; width: 90%; background: var(--blue); color: white; padding: 16px; border-radius: 16px; font-weight: bold; border: none; z-index: 100; cursor: pointer; }
        .card-table-row { display: flex; justify-content: space-between; align-items: center; background: #161b22; padding: 12px; border-bottom: 1px solid #30363d; }
        .card-foul-badge { background: rgba(218, 54, 51, 0.2); color: var(--red); border: 1px solid var(--red); padding: 4px 8px; border-radius: 6px; font-weight: bold; font-family: monospace; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; overflow-y: auto; }
        .modal-content { background: #161b22; margin: 10% auto; padding: 20px; width: 85%; border-radius: 12px; border: 1px solid #30363d; }
        .hist-date-row { display: flex; justify-content: space-between; padding: 10px; background: #21262d; border-radius: 8px; margin-bottom: 8px; font-weight: bold; }
        .unit-win { color: var(--green); } .unit-loss { color: var(--red); }
    </style>
</head>
<body>

    <header>
        <div class="top-row">
            <h1>The Final Third</h1>
            <div class="header-right">
                <div id="apiCounter" class="api-badge">API: 0</div>
                <button class="help-btn" onclick="openHelp()">?</button>
            </div>
        </div>
        <button id="pilotBtn" class="pilot-btn" onclick="togglePilot()"><div class="pilot-dot"></div> Auto-Pilot</button>
        <div class="nav-tabs">
            <div id="tabLive" class="nav-tab active" onclick="switchTab('live')">üî¥ Live Hunt</div>
            <div id="tabCards" class="nav-tab" onclick="switchTab('cards')">üü® Card Watch</div>
            <div id="tabHist" class="nav-tab" onclick="switchTab('hist')">üìú History</div>
        </div>
        <select id="filterSelect" onchange="applyFilter()">
            <option value="elite">üá¨üáß UK & Elite</option>
            <option value="europe">üá™üá∫ Europe</option>
            <option value="world">üåé World Scan</option>
        </select>
    </header>

    <div id="liveView">
        <div class="chip-container">
            <div class="chip active" onclick="setStrategy('all', this)">üåç All</div>
            <div class="chip" onclick="setStrategy('losing', this)">ü©∏ Fav Losing</div>
            <div class="chip" onclick="setStrategy('drought', this)">‚è≥ Drought</div>
            <div class="chip" onclick="setStrategy('red', this)">üü• Red Card</div>
            <div class="chip" onclick="setStrategy('late', this)">üß® Late</div>
        </div>
        <div id="content"></div>
        <button class="scan-btn" onclick="runScan()" id="mainBtn">üéØ SCAN MARKETS</button>
    </div>

    <div id="cardView" style="display:none; padding-bottom:100px;">
        <button class="card-scan-btn" style="width:100%; background:var(--red); color:white; padding:14px; border-radius:8px; border:none; margin-bottom:15px; font-weight:bold; cursor:pointer;" onclick="scanGlobalCards(this)">‚ö†Ô∏è SCAN ACTIVE CARD RISKS</button>
        <div id="cardContent"></div>
    </div>
    <div id="histView" style="display:none; padding-bottom:100px;"><div id="histContent"></div></div>

    <div id="helpModal" class="modal" onclick="closeHelp(event)">
        <div class="modal-content">
            <h2 style="color:var(--blue)">User Manual</h2>
            <p><b>Drought:</b> Games with >50m since last goal.</p>
            <p><b>Card Watch:</b> Only shows players currently on the pitch.</p>
            <p><b>History:</b> Daily profit/loss summary.</p>
            <button onclick="document.getElementById('helpModal').style.display='none'" style="width:100%; padding:12px; margin-top:10px; background:#333; color:white; border:none; border-radius:8px;">Close</button>
        </div>
    </div>

    <script>
        const API_KEY = "0f29a2f96e9dd4231cee515cc5ec52b0";
        const ELITE_IDS = [39, 40, 45, 48, 179, 180, 140, 78, 135, 61, 88, 94, 144, 2, 3, 529, 556, 81, 143, 307, 253];
        let allMatches = [], pilotMode = false, pilotInterval, currentStrategy = 'all';

        const trackAPI = (count) => {
            let current = parseInt(localStorage.getItem('apiCount') || "0") + count;
            localStorage.setItem('apiCount', current);
            document.getElementById('apiCounter').innerText = `API: ${current}`;
        };

        const switchTab = (tab) => {
            ['liveView','cardView','histView'].forEach(v => document.getElementById(v).style.display = 'none');
            document.getElementById(tab + 'View').style.display = 'block';
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            if(tab === 'hist') renderHistory();
        };

        function toggleBet(id, homeGoals, awayGoals) {
            let bets = JSON.parse(localStorage.getItem('betHistory') || "[]");
            const today = new Date().toLocaleDateString('en-CA');
            const idx = bets.findIndex(b => b.id === id);
            if(idx >= 0) bets.splice(idx, 1);
            else bets.push({ id, date: today, goalsAtBet: homeGoals + awayGoals, status: 'OPEN' });
            localStorage.setItem('betHistory', JSON.stringify(bets));
            applyFilter();
        }

        async function runScan(isAuto = false) {
            trackAPI(1);
            if(!isAuto) document.getElementById('content').innerHTML = "<p style='text-align:center; margin-top:50px'>Scanning...</p>";
            try {
                const res = await fetch("https://v3.football.api-sports.io/fixtures?live=all", { headers: { "x-rapidapi-key": API_KEY } });
                const data = await res.json();
                allMatches = data.response.filter(m => m.fixture.status.elapsed >= 60 && m.fixture.status.elapsed <= 85);
                applyFilter(isAuto);
                checkOutcomes();
            } catch(e) { console.error(e); }
        }

        function applyFilter(isAuto = false) {
            const content = document.getElementById('content');
            content.innerHTML = "";
            const mode = document.getElementById('filterSelect').value;
            const placed = JSON.parse(localStorage.getItem('betHistory') || "[]").map(b => b.id);
            
            const filtered = allMatches.filter(m => {
                if (mode === 'elite' && !ELITE_IDS.includes(m.league.id)) return false;
                if (currentStrategy === 'losing') return m.goals.home < m.goals.away;
                if (currentStrategy === 'late') return m.fixture.status.elapsed >= 80;
                if (currentStrategy === 'drought') {
                    const lastGoal = m.events?.filter(e => e.type === 'Goal').pop()?.time.elapsed || 0;
                    return (m.goals.home + m.goals.away > 0) && (m.fixture.status.elapsed - lastGoal > 50);
                }
                return true;
            });
            filtered.forEach(m => createCard(m, placed.includes(m.fixture.id)));
            if(mode === 'elite') enrichEliteMatches(filtered);
        }

        function createCard(m, isPlaced) {
            const div = document.createElement('div');
            div.className = 'match-card';
            div.innerHTML = `
                <div style="font-size:0.75rem; color:#888; margin-bottom:8px;">${m.league.name}</div>
                <div class="score-row">
                    <div style="flex:1; text-align:right;"><span id="rank-h-${m.fixture.id}" class="rank-on-card"></span> ${m.teams.home.name}</div>
                    <div class="score-box">${m.goals.home}-${m.goals.away}</div>
                    <div style="flex:1; text-align:left;">${m.teams.away.name} <span id="rank-a-${m.fixture.id}" class="rank-on-card"></span></div>
                </div>
                <div id="stats-${m.fixture.id}" class="analysis-box" style="display:none; text-align:center; color:#888;">Loading Stats...</div>
                <div class="btn-row">
                    <a href="https://www.bet365.com" class="bet365-btn">Bet365</a>
                    <button class="mark-btn ${isPlaced ? 'active' : ''}" onclick="toggleBet(${m.fixture.id}, ${m.goals.home}, ${m.goals.away})">üìå</button>
                </div>
            `;
            document.getElementById('content').appendChild(div);
        }

        async function enrichEliteMatches(matches) {
            for (const m of matches) {
                const box = document.getElementById(`stats-${m.fixture.id}`);
                if(box) { box.style.display = 'block'; await deepAnalyze(m.fixture.id, m.league.id, m.league.season); }
                await new Promise(r => setTimeout(r, 400));
            }
        }

        async function deepAnalyze(id, lid, season) {
            trackAPI(2);
            try {
                const [sRes, stRes] = await Promise.all([
                    fetch(`https://v3.football.api-sports.io/fixtures/statistics?fixture=${id}`, { headers: { "x-rapidapi-key": API_KEY } }),
                    fetch(`https://v3.football.api-sports.io/standings?league=${lid}&season=${season}`, { headers: { "x-rapidapi-key": API_KEY } })
                ]);
                const stats = await sRes.json();
                const stand = await stRes.json();
                const box = document.getElementById(`stats-${id}`);
                if (!stats.response[0]) { box.innerHTML = "Stats unavailable."; return; }

                const getS = (arr, t) => parseInt(arr.find(x => x.type === t)?.value || 0);
                const hPress = (getS(stats.response[0].statistics, "Shots on Goal") * 5) + (getS(stats.response[0].statistics, "Corner Kicks") * 2);
                const aPress = (getS(stats.response[1].statistics, "Shots on Goal") * 5) + (getS(stats.response[1].statistics, "Corner Kicks") * 2);
                const hPct = Math.round((hPress / (hPress + aPress || 1)) * 100);

                box.innerHTML = `<div style="display:flex; justify-content:space-between;"><span>Pressure: ${hPct}%</span><span>${100-hPct}%</span></div>
                    <div style="height:8px; background:#333; border-radius:4px; overflow:hidden; display:flex; margin-top:5px;">
                        <div style="width:${hPct}%; background:var(--green)"></div><div style="width:${100-hPct}%; background:var(--purple)"></div>
                    </div>`;
                
                if(stand.response[0]) {
                    const table = stand.response[0].league.standings[0];
                    const hRank = table.find(t => t.team.name.includes(allMatches.find(m => m.fixture.id === id).teams.home.name))?.rank;
                    const aRank = table.find(t => t.team.name.includes(allMatches.find(m => m.fixture.id === id).teams.away.name))?.rank;
                    if(hRank) document.getElementById(`rank-h-${id}`).innerText = `[#${hRank}]`;
                    if(aRank) document.getElementById(`rank-a-${id}`).innerText = `[#${aRank}]`;
                }
            } catch(e) {}
        }

        async function scanGlobalCards(btn) {
            btn.innerText = "Scanning Pitch...";
            const area = document.getElementById('cardContent');
            area.innerHTML = "<p style='text-align:center; color:#888'>Checking active players only...</p>";
            const eliteLive = allMatches.filter(m => ELITE_IDS.includes(m.league.id));
            let players = [];

            for (const m of eliteLive) {
                trackAPI(1);
                const res = await fetch(`https://v3.football.api-sports.io/fixtures/players?fixture=${m.fixture.id}`, { headers: { "x-rapidapi-key": API_KEY } });
                const data = await res.json();
                data.response?.forEach(teamData => teamData.players.forEach(p => {
                    const s = p.statistics[0];
                    // Updated logic: Committed 2+ fouls, 0 cards, and hasn't been subbed off
                    const isOff = m.events?.some(e => e.type === 'Substitute' && e.player.id === p.player.id);
                    if (s.fouls.committed >= 2 && !s.cards.yellow && !s.cards.red && !isOff) {
                        players.push({ name: p.player.name, team: teamData.team.name, fouls: s.fouls.committed, time: m.fixture.status.elapsed });
                    }
                }));
                await new Promise(r => setTimeout(r, 400));
            }
            players.sort((a,b) => b.fouls - a.fouls);
            area.innerHTML = players.length ? players.map(p => `
                <div class="card-table-row">
                    <div><b>${p.name}</b><br><small>${p.team} ‚Ä¢ ${p.time}'</small></div>
                    <div class="card-foul-badge">${p.fouls} Fouls</div>
                </div>`).join('') : "<p style='text-align:center'>No active risks found.</p>";
            btn.innerText = "‚ö†Ô∏è SCAN ACTIVE CARD RISKS";
        }

        function checkOutcomes() {
            let bets = JSON.parse(localStorage.getItem('betHistory') || "[]");
            let changed = false;
            bets.forEach(b => {
                const m = allMatches.find(x => x.fixture.id === b.id);
                if(m && b.status === 'OPEN' && (m.goals.home + m.goals.away > b.goalsAtBet)) { b.status = 'WIN'; changed = true; }
            });
            if(changed) localStorage.setItem('betHistory', JSON.stringify(bets));
        }

        function renderHistory() {
            const bets = JSON.parse(localStorage.getItem('betHistory') || "[]");
            const grouped = bets.reduce((acc, b) => {
                acc[b.date] = (acc[b.date] || 0) + (b.status === 'WIN' ? 1 : b.status === 'LOSS' ? -1 : 0);
                return acc;
            }, {});
            const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
            document.getElementById('histContent').innerHTML = sortedDates.length ? sortedDates.map(d => `
                <div class="hist-date-row">
                    <span>üìÖ ${d}</span>
                    <span class="${grouped[d] >= 0 ? 'unit-win' : 'unit-loss'}">${grouped[d] > 0 ? '+' : ''}${grouped[d]} Units</span>
                </div>`).join('') : "<p style='text-align:center'>No history found.</p>";
        }

        function togglePilot() {
            pilotMode = !pilotMode;
            document.getElementById('pilotBtn').classList.toggle('active', pilotMode);
            document.getElementById('pilotBtn').innerHTML = pilotMode ? `<div class="pilot-dot"></div> ON (5m)` : `<div class="pilot-dot"></div> Auto-Pilot`;
            if(pilotMode) { runScan(true); pilotInterval = setInterval(() => runScan(true), 300000); }
            else clearInterval(pilotInterval);
        }

        function openHelp() { document.getElementById('helpModal').style.display = 'block'; }
        function closeHelp(e) { if(e.target.id === 'helpModal') e.target.style.display = 'none'; }
        function setStrategy(s, el) { 
            currentStrategy = s; 
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); 
            el.classList.add('active'); 
            applyFilter(); 
        }
    </script>
</body>
</html>
