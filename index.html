<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d1117">
    <title>The Final Third</title>

    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="target_PNG26.png">
    <link rel="apple-touch-icon" href="target_PNG26.png">

    <style>
        :root { --bg: #0d1117; --card: #161b22; --green: #2ea043; --gold: #d29922; --red: #da3633; --purple: #a371f7; --blue: #1f6feb; --text: #c9d1d9; --cyan: #3fb950; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 16px; padding-bottom: 120px; }
        
        header { display: flex; flex-direction: column; gap: 10px; border-bottom: 1px solid #30363d; padding-bottom: 15px; margin-bottom: 15px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        h1 { margin: 0; font-size: 1.4rem; color: var(--blue); display: flex; align-items: center; gap: 10px; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .api-badge { background: #21262d; border: 1px solid #30363d; color: #8b949e; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-family: monospace; font-weight: bold; }
        .help-btn { background: #21262d; border: 1px solid #30363d; color: var(--gold); width: 28px; height: 28px; border-radius: 50%; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(46, 160, 67, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(46, 160, 67, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 160, 67, 0); } }
        @keyframes pulse-purple { 0% { box-shadow: 0 0 0 0 rgba(163, 113, 247, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(163, 113, 247, 0); } 100% { box-shadow: 0 0 0 0 rgba(163, 113, 247, 0); } }

        .pilot-btn { background: #21262d; border: 1px solid #30363d; color: #888; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.3s; }
        .pilot-btn.active { background: rgba(46, 160, 67, 0.2); border-color: var(--green); color: var(--green); }
        .pilot-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .pilot-btn.active .pilot-dot { background: var(--green); box-shadow: 0 0 8px var(--green); }

        .nav-tabs { display: flex; gap: 10px; margin-top: 15px; overflow-x: auto; padding-bottom: 5px; }
        .nav-tab { flex: 1; text-align: center; padding: 10px; background: #21262d; border-radius: 8px; border: 1px solid #30363d; color: #888; font-weight: bold; cursor: pointer; font-size: 0.9rem; white-space: nowrap; }
        .nav-tab.active { background: var(--blue); color: white; border-color: var(--blue); }

        select { width: 100%; padding: 12px; background: #21262d; color: white; border: 1px solid #30363d; border-radius: 8px; font-size: 1rem; font-weight: bold; outline: none; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto; }

        .chip-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .chip { white-space: nowrap; padding: 6px 12px; border-radius: 20px; background: #21262d; border: 1px solid #30363d; color: #888; font-size: 0.8rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .chip.active { background: #d29922; color: #0d1117; border-color: #d29922; }

        .match-card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; }
        .match-card.pulse-home { animation: pulse-green 2s infinite; border-color: var(--green); }
        .match-card.pulse-away { animation: pulse-purple 2s infinite; border-color: var(--purple); }

        .placed-badge { position: absolute; top: 0; right: 0; background: var(--green); color: white; font-size: 0.7rem; font-weight: bold; padding: 4px 8px; border-bottom-left-radius: 8px; }
        .league-name { font-size: 0.75rem; color: #8b949e; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .score-row { display: flex; justify-content: space-between; align-items: flex-start; margin: 10px 0; }
        .team-col { width: 40%; display: flex; flex-direction: column; }
        .team-name { font-size: 1rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .goal-times { font-size: 0.75rem; color: var(--gold); margin-top: 4px; min-height: 14px; font-family: monospace; }
        .score-box { background: #21262d; padding: 8px 14px; border-radius: 8px; border: 1px solid #30363d; font-family: monospace; font-size: 1.2rem; font-weight: bold; }
        
        .rank-on-card { color: var(--gold); font-size: 0.8rem; font-weight: bold; font-family: monospace; }

        .hist-date-row { display: flex; justify-content: space-between; padding: 10px; background: #21262d; border-radius: 8px; font-weight: bold; margin-bottom: 10px; }
        .hist-unit-plus { color: var(--green); } .hist-unit-minus { color: var(--red); }

        .card-table-row { display: flex; justify-content: space-between; align-items: center; background: #161b22; padding: 12px; border-bottom: 1px solid #30363d; }
        .card-foul-badge { background: rgba(218, 54, 51, 0.2); color: var(--red); border: 1px solid var(--red); padding: 4px 8px; border-radius: 6px; font-weight: bold; font-family: monospace; }
        .ref-badge { font-size: 0.7rem; background: #333; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }

        .analysis-box { background: #1c1c1c; border: 1px solid var(--purple); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .stat-bar { display: flex; justify-content: space-between; margin-bottom: 4px; color: #bbb; font-size: 0.8rem; }
        .gauge-container { height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin: 5px 0 10px 0; display: flex; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .bet365-btn { flex: 1; background: #00703c; border: 1px solid #005c31; color: white; padding: 10px; border-radius: 8px; font-weight: bold; text-decoration: none; text-align: center; }
        .mark-btn { background: #21262d; border: 1px solid #30363d; color: #888; border-radius: 8px; padding: 0 15px; cursor: pointer; }
        .mark-btn.active { background: var(--green); color: white; }

        .scan-btn { position: fixed; bottom: 30px; left: 5%; width: 90%; background: var(--blue); color: white; border: none; padding: 16px; border-radius: 16px; font-size: 1.1rem; font-weight: bold; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 100; cursor: pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; overflow-y: auto; }
        .modal-content { background: #161b22; margin: 10% auto; padding: 20px; width: 85%; border-radius: 12px; border: 1px solid #30363d; max-width: 500px; padding-bottom: 100px; }
        details { margin-bottom: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; border: 1px solid #30363d; }
        summary { cursor: pointer; font-weight: bold; color: var(--blue); outline: none; }
        .synth-badge { font-size: 0.7rem; background: rgba(63, 185, 80, 0.2); color: var(--cyan); padding: 2px 4px; border-radius: 3px; margin-left: 5px; border: 1px solid var(--cyan); }
    </style>
</head>
<body>

    <header>
        <div class="top-row">
            <h1>The Final Third</h1>
            <div class="header-right">
                <div id="apiCounter" class="api-badge">API: 0</div>
                <button class="help-btn" onclick="openHelp()">?</button>
            </div>
        </div>
        <button id="pilotBtn" class="pilot-btn" onclick="togglePilot()"><div class="pilot-dot"></div> Auto-Pilot</button>
        <div class="nav-tabs">
            <div id="tabLive" class="nav-tab active" onclick="switchTab('live')">üî¥ Live Hunt</div>
            <div id="tabCards" class="nav-tab" onclick="switchTab('cards')">üü® Card Watch</div>
            <div id="tabHist" class="nav-tab" onclick="switchTab('hist')">üìú History</div>
        </div>
        <select id="filterSelect" onchange="applyFilter()">
            <option value="elite">üá¨üáß UK & Elite</option>
            <option value="europe">üá™üá∫ Europe</option>
            <option value="world">üåé World Scan</option>
        </select>
    </header>

    <div id="liveView">
        <div class="chip-container">
            <div class="chip active" onclick="setStrategy('all', this)">üåç All</div>
            <div class="chip" onclick="setStrategy('losing', this)">ü©∏ Fav Losing</div>
            <div class="chip" onclick="setStrategy('drought', this)">‚è≥ Goal Drought</div>
            <div class="chip" onclick="setStrategy('red', this)">üü• Red Card</div>
            <div class="chip" onclick="setStrategy('late', this)">üß® Late</div>
        </div>
        <div id="content"></div>
        <button class="scan-btn" onclick="runScan()" id="mainBtn">üéØ SCAN MARKETS</button>
    </div>

    <div id="cardView" style="display:none; padding-bottom:100px;">
        <button class="scan-btn" style="position:static; width:100%; background:var(--red); margin-bottom:15px;" onclick="scanGlobalCards(this)">‚ö†Ô∏è SCAN ACTIVE CARD RISKS</button>
        <div id="cardContent"></div>
    </div>
    <div id="histView" style="display:none; padding-bottom:100px;"><div id="histContent"></div></div>

    <div id="helpModal" class="modal" onclick="closeHelp(event)">
        <div class="modal-content">
            <h2 style="color:var(--blue)">User Manual</h2>
            <details open><summary>üî¥ Live & Auto-Pilot</summary><p>Scans every 5 mins. Auto-analyzes Elite games Waterfall-style to avoid API bans.</p></details>
            <details><summary>‚è≥ Goal Drought</summary><p>Finds matches with >1 goal where no one has scored for 50+ minutes.</p></details>
            <details><summary>üèÜ Elite Leagues List</summary>
                <ul>
                    <li>Premier League & Champ</li>
                    <li>La Liga, Bundesliga, Serie A, Ligue 1</li>
                    <li>Eredivisie, Primeira Liga, MLS</li>
                    <li>Scottish Premiership (SPL), Saudi Pro League</li>
                </ul>
            </details>
            <button onclick="document.getElementById('helpModal').style.display='none'" style="width:100%; padding:12px; margin-top:10px; background:#333; color:white; border:none; border-radius:8px;">Close</button>
        </div>
    </div>

    <script>
        const API_KEY = "0f29a2f96e9dd4231cee515cc5ec52b0";
        const ELITE_IDS = [39, 40, 45, 48, 179, 180, 140, 78, 135, 61, 88, 94, 144, 2, 3, 529, 556, 81, 143, 307, 253];
        let allMatches = [], pilotMode = false, pilotInterval, currentStrategy = 'all';

        const trackAPI = (count) => {
            let current = parseInt(localStorage.getItem('apiCount') || "0") + count;
            localStorage.setItem('apiCount', current);
            document.getElementById('apiCounter').innerText = `API: ${current}`;
        };

        const switchTab = (tab) => {
            ['liveView','cardView','histView'].forEach(v => document.getElementById(v).style.display = 'none');
            document.getElementById(tab + 'View').style.display = 'block';
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            if(tab === 'hist') renderHistory();
        };

        async function runScan(isAuto = false) {
            trackAPI(1);
            if(!isAuto) document.getElementById('content').innerHTML = "<p style='text-align:center; padding:50px;'>Fetching live data...</p>";
            try {
                const res = await fetch("https://v3.football.api-sports.io/fixtures?live=all", { headers: { "x-rapidapi-key": API_KEY } });
                const data = await res.json();
                allMatches = data.response.filter(m => m.fixture.status.elapsed >= 60 && m.fixture.status.elapsed <= 85);
                applyFilter(isAuto);
            } catch(e) { console.error(e); }
        }

        function applyFilter(isAuto = false) {
            const mode = document.getElementById('filterSelect').value;
            const content = document.getElementById('content');
            content.innerHTML = "";
            const placed = JSON.parse(localStorage.getItem('betHistory') || "[]").map(b => b.id);
            
            const filtered = allMatches.filter(m => {
                if (mode === 'elite' && !ELITE_IDS.includes(m.league.id)) return false;
                if (currentStrategy === 'losing') return m.goals.home < m.goals.away;
                if (currentStrategy === 'late') return m.fixture.status.elapsed >= 80;
                if (currentStrategy === 'drought') {
                    const goalEvents = m.events?.filter(e => e.type === 'Goal') || [];
                    if (m.goals.home + m.goals.away === 0 || goalEvents.length === 0) return false;
                    const lastGoal = goalEvents[goalEvents.length - 1].time.elapsed;
                    return (m.fixture.status.elapsed - lastGoal > 50);
                }
                return true;
            });

            filtered.forEach(m => {
                const isElite = ELITE_IDS.includes(m.league.id);
                createCard(m, placed.includes(m.fixture.id), isElite);
            });
            
            if(mode === 'elite' || filtered.some(m => ELITE_IDS.includes(m.league.id))) {
                enrichMatchesWaterfall(filtered.filter(m => ELITE_IDS.includes(m.league.id)));
            }
        }

        function createCard(m, isPlaced, isElite) {
            const div = document.createElement('div');
            div.className = 'match-card';
            div.id = `card-${m.fixture.id}`;
            div.innerHTML = `
                <div class="league-name">${m.league.name}</div>
                ${isPlaced ? '<div class="placed-badge">PINNED</div>' : ''}
                <div class="score-row">
                    <div class="team-col" style="text-align:right;">
                        <span class="team-name"><span id="rank-h-${m.fixture.id}" class="rank-on-card"></span> ${m.teams.home.name}</span>
                    </div>
                    <div class="score-box">${m.goals.home}-${m.goals.away}</div>
                    <div class="team-col" style="text-align:left;">
                        <span class="team-name">${m.teams.away.name} <span id="rank-a-${m.fixture.id}" class="rank-on-card"></span></span>
                    </div>
                </div>
                <div id="stats-${m.fixture.id}" class="analysis-box" style="display:${isElite ? 'block' : 'none'}; text-align:center; color:#666;">
                    ${isElite ? 'Waiting for waterfall...' : ''}
                </div>
                <div class="btn-row">
                    <a href="https://www.bet365.com" class="bet365-btn">Bet365</a>
                    <button class="mark-btn ${isPlaced ? 'active' : ''}" onclick="toggleBet(${m.fixture.id}, ${m.goals.home}, ${m.goals.away})">üìå</button>
                </div>
            `;
            document.getElementById('content').appendChild(div);
        }

        async function enrichMatchesWaterfall(matches) {
            for (const m of matches) {
                const box = document.getElementById(`stats-${m.fixture.id}`);
                if(box) await deepAnalyze(m.fixture.id, m.league.id, m.league.season);
                await new Promise(r => setTimeout(r, 500));
            }
        }

        async function deepAnalyze(id, lid, season) {
            trackAPI(3);
            try {
                const [sRes, stRes] = await Promise.all([
                    fetch(`https://v3.football.api-sports.io/fixtures/statistics?fixture=${id}`, { headers: { "x-rapidapi-key": API_KEY } }),
                    fetch(`https://v3.football.api-sports.io/standings?league=${lid}&season=${season}`, { headers: { "x-rapidapi-key": API_KEY } })
                ]);
                const stats = await sRes.json();
                const stand = await stRes.json();
                const box = document.getElementById(`stats-${id}`);
                
                let isSynth = false;
                let hStats = stats.response[0]?.statistics;
                let aStats = stats.response[1]?.statistics;

                if (!hStats) {
                    isSynth = true;
                    trackAPI(1);
                    const pRes = await fetch(`https://v3.football.api-sports.io/fixtures/players?fixture=${id}`, { headers: { "x-rapidapi-key": API_KEY } });
                    const pData = await pRes.json();
                    if(pData.response) {
                        let hS = 0, aS = 0;
                        pData.response[0].players.forEach(p => hS += (p.statistics[0].shots.total || 0));
                        pData.response[1].players.forEach(p => aS += (p.statistics[0].shots.total || 0));
                        hStats = [{type:"Total Shots", value:hS}, {type:"Shots on Goal", value: Math.floor(hS/2)}];
                        aStats = [{type:"Total Shots", value:aS}, {type:"Shots on Goal", value: Math.floor(aS/2)}];
                    }
                }

                const getVal = (arr, t) => parseInt(arr.find(x => x.type === t)?.value || 0);
                const hP = (getVal(hStats, "Shots on Goal") * 5) + (getVal(hStats, "Corner Kicks") * 2) + getVal(hStats, "Total Shots");
                const aP = (getVal(aStats, "Shots on Goal") * 5) + (getVal(aStats, "Corner Kicks") * 2) + getVal(aStats, "Total Shots");
                const hPct = Math.round((hP / (hP + aP || 1)) * 100);

                box.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span>Pressure: ${hPct}% ${isSynth ? '<span class="synth-badge">SYNTH</span>' : ''}</span>
                        <span>${100-hPct}%</span>
                    </div>
                    <div class="gauge-container">
                        <div style="width:${hPct}%; background:var(--green); height:100%;"></div>
                        <div style="width:${100-hPct}%; background:var(--purple); height:100%;"></div>
                    </div>
                `;

                const card = document.getElementById(`card-${id}`);
                if(hPct > 70) card.classList.add('pulse-home');
                if((100-hPct) > 70) card.classList.add('pulse-away');

                if(stand.response[0]) {
                    const table = stand.response[0].league.standings[0];
                    const hT = allMatches.find(m => m.fixture.id === id).teams.home.name;
                    const aT = allMatches.find(m => m.fixture.id === id).teams.away.name;
                    const hR = table.find(t => t.team.name.includes(hT))?.rank;
                    const aR = table.find(t => t.team.name.includes(aT))?.rank;
                    if(hR) document.getElementById(`rank-h-${id}`).innerText = `[#${hR}]`;
                    if(aR) document.getElementById(`rank-a-${id}`).innerText = `[#${aR}]`;
                }
            } catch(e) { console.error(e); }
        }

        async function scanGlobalCards(btn) {
            btn.innerText = "Scanning Players...";
            const area = document.getElementById('cardContent');
            area.innerHTML = "<p style='text-align:center; padding:20px;'>Checking current on-pitch targets...</p>";
            const elite = allMatches.filter(m => ELITE_IDS.includes(m.league.id));
            let risks = [];

            for (const m of elite) {
                trackAPI(1);
                const res = await fetch(`https://v3.football.api-sports.io/fixtures/players?fixture=${m.fixture.id}`, { headers: { "x-rapidapi-key": API_KEY } });
                const data = await res.json();
                data.response?.forEach(team => team.players.forEach(p => {
                    const s = p.statistics[0];
                    const isOff = m.events?.some(e => e.type === 'Substitute' && e.player.id === p.player.id);
                    if (s.fouls.committed >= 2 && !s.cards.yellow && !s.cards.red && !isOff) {
                        risks.push({ name: p.player.name, team: team.team.name, fouls: s.fouls.committed, time: m.fixture.status.elapsed });
                    }
                }));
                await new Promise(r => setTimeout(r, 400));
            }
            area.innerHTML = risks.length ? risks.map(r => `<div class="card-table-row"><div><b>${r.name}</b><br><small>${r.team} ‚Ä¢ ${r.time}'</small></div><div class="card-foul-badge">${r.fouls} Fouls</div></div>`).join('') : "<p style='text-align:center;'>No risks found.</p>";
            btn.innerText = "‚ö†Ô∏è SCAN ACTIVE CARD RISKS";
        }

        function toggleBet(id, hG, aG) {
            let bets = JSON.parse(localStorage.getItem('betHistory') || "[]");
            const idx = bets.findIndex(b => b.id === id);
            if(idx >= 0) bets.splice(idx, 1);
            else bets.push({ id, date: new Date().toLocaleDateString('en-CA'), goalsAtBet: hG+aG, status: 'OPEN' });
            localStorage.setItem('betHistory', JSON.stringify(bets));
            applyFilter();
        }

        function renderHistory() {
            const bets = JSON.parse(localStorage.getItem('betHistory') || "[]");
            const grouped = bets.reduce((acc, b) => {
                const units = b.status === 'WIN' ? 1 : b.status === 'LOSS' ? -1 : 0;
                acc[b.date] = (acc[b.date] || 0) + units;
                return acc;
            }, {});
            const sorted = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
            document.getElementById('histContent').innerHTML = sorted.length ? sorted.map(d => `<div class="hist-date-row"><span>üìÖ ${d}</span><span class="${grouped[d] >= 0 ? 'hist-unit-plus' : 'hist-unit-minus'}">${grouped[d] > 0 ? '+' : ''}${grouped[d]} Units</span></div>`).join('') : "<p style='text-align:center;'>No history.</p>";
        }

        function togglePilot() {
            pilotMode = !pilotMode;
            document.getElementById('pilotBtn').classList.toggle('active', pilotMode);
            document.getElementById('pilotBtn').innerHTML = pilotMode ? `<div class="pilot-dot"></div> ON (5m)` : `<div class="pilot-dot"></div> Auto-Pilot`;
            if(pilotMode) { runScan(true); pilotInterval = setInterval(() => runScan(true), 300000); }
            else clearInterval(pilotInterval);
        }

        function openHelp() { document.getElementById('helpModal').style.display = 'block'; }
        function closeHelp(e) { if(e.target.id === 'helpModal') e.target.style.display = 'none'; }
        function setStrategy(s, el) { currentStrategy = s; document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); applyFilter(); }
    </script>
</body>
</html>
