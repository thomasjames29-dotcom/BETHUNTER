<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d1117">
    <title>The Final Third</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="target_PNG26.png">
    <link rel="apple-touch-icon" sizes="180x180" href="target_PNG26.png">
    <link rel="icon" type="image/png" sizes="32x32" href="target_PNG26.png">
    <link rel="icon" type="image/png" sizes="16x16" href="target_PNG26.png">
    
    <!-- iOS support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Final Third">

    <style>
        :root { --bg: #0d1117; --card: #161b22; --green: #2ea043; --gold: #d29922; --red: #da3633; --purple: #a371f7; --blue: #1f6feb; --text: #c9d1d9; --cyan: #3fb950; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 16px; padding-bottom: 120px; }
        
        /* HEADER */
        header { display: flex; flex-direction: column; gap: 10px; border-bottom: 1px solid #30363d; padding-bottom: 15px; margin-bottom: 15px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        h1 { margin: 0; font-size: 1.4rem; color: var(--blue); display: flex; align-items: center; gap: 10px; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .api-badge { background: #21262d; border: 1px solid #30363d; color: #8b949e; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-family: monospace; font-weight: bold; }
        .help-btn { background: #21262d; border: 1px solid #30363d; color: var(--gold); width: 28px; height: 28px; border-radius: 50%; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* PULSE ANIMATIONS */
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(46, 160, 67, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(46, 160, 67, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 160, 67, 0); } }
        @keyframes pulse-purple { 0% { box-shadow: 0 0 0 0 rgba(163, 113, 247, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(163, 113, 247, 0); } 100% { box-shadow: 0 0 0 0 rgba(163, 113, 247, 0); } }

        /* AUTO-PILOT */
        .pilot-btn { background: #21262d; border: 1px solid #30363d; color: #888; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.3s; }
        .pilot-btn.active { background: rgba(46, 160, 67, 0.2); border-color: var(--green); color: var(--green); }
        .pilot-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .pilot-btn.active .pilot-dot { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .pilot-btn.paused { border-color: var(--gold); color: var(--gold); animation: none; }

        /* TABS */
        .nav-tabs { display: flex; gap: 10px; margin-top: 15px; overflow-x: auto; padding-bottom: 5px; }
        .nav-tab { flex: 1; text-align: center; padding: 10px; background: #21262d; border-radius: 8px; border: 1px solid #30363d; color: #888; font-weight: bold; cursor: pointer; font-size: 0.9rem; white-space: nowrap; }
        .nav-tab.active { background: var(--blue); color: white; border-color: var(--blue); }

        select { width: 100%; padding: 12px; background: #21262d; color: white; border: 1px solid #30363d; border-radius: 8px; font-size: 1rem; font-weight: bold; outline: none; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto; }

        /* STRATEGY CHIPS */
        .chip-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .chip-container::-webkit-scrollbar { display: none; }
        .chip { position: relative; white-space: nowrap; padding: 6px 12px; border-radius: 20px; background: #21262d; border: 1px solid #30363d; color: #888; font-size: 0.8rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .chip.active { background: #d29922; color: #0d1117; border-color: #d29922; }
        .chip-badge { position: absolute; top: -6px; right: -4px; background: var(--blue); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; border: 2px solid var(--bg); display: none; z-index: 5; }
        .chip-badge.active { display: block !important; }
        .chip-badge.urgent { background: var(--red); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* CARDS */
        .match-card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; overflow: hidden; transition: all 0.3s; }
        .match-card:hover { border-color: #444; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .match-card.placed { border: 1px solid var(--green); background: rgba(46, 160, 67, 0.05); }
        .match-card.ghost { opacity: 0.5; border-color: #30363d; filter: grayscale(0.8); }
        .match-card.ghost:hover { opacity: 1; filter: grayscale(0); }
        .match-card.pulse-home { animation: pulse-green 2s infinite; border-color: var(--green); }
        .match-card.pulse-away { animation: pulse-purple 2s infinite; border-color: var(--purple); }

        .placed-badge { position: absolute; top: 0; right: 0; background: var(--green); color: white; font-size: 0.7rem; font-weight: bold; padding: 4px 8px; border-bottom-left-radius: 8px; }
        .league-name { font-size: 0.75rem; color: #8b949e; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .score-row { display: flex; justify-content: space-between; align-items: flex-start; margin: 10px 0; }
        .team-col { width: 40%; display: flex; flex-direction: column; }
        .team-name { font-size: 1rem; font-weight: bold; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; display: flex; align-items: center; gap: 5px; }
        .goal-times { font-size: 0.75rem; color: var(--gold); margin-top: 4px; min-height: 14px; font-family: monospace; }
        .score-box { background: #21262d; padding: 8px 14px; border-radius: 8px; border: 1px solid #30363d; font-family: monospace; font-size: 1.2rem; font-weight: bold; }
        
        /* RANK BADGE ON CARD */
        .rank-on-card { color: var(--gold); font-size: 0.8rem; font-weight: bold; font-family: monospace; }

        /* SCHED ITEM */
        .sched-card { background: #161b22; border-bottom: 1px solid #30363d; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .sched-time { font-family: monospace; color: var(--gold); font-weight: bold; width: 50px; font-size: 1rem; }
        .sched-teams { flex: 1; font-size: 0.9rem; }
        .sched-league { font-size: 0.75rem; color: #a371f7; text-transform: uppercase; margin-bottom: 4px; font-weight: bold; letter-spacing: 0.5px; }

        /* HISTORY ITEM */
        .hist-day { margin-bottom: 20px; }
        .hist-date-row { display: flex; justify-content: space-between; padding: 10px; background: #21262d; border-radius: 8px; font-weight: bold; margin-bottom: 10px; }
        .hist-unit-plus { color: var(--green); } .hist-unit-minus { color: var(--red); } .hist-unit-even { color: #888; }
        .hist-card { background: #161b22; border-bottom: 1px solid #30363d; padding: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        .hist-res-win { color: var(--green); font-weight: bold; border: 1px solid var(--green); padding: 2px 6px; border-radius: 4px; }
        .hist-res-loss { color: var(--red); font-weight: bold; border: 1px solid var(--red); padding: 2px 6px; border-radius: 4px; }
        .hist-res-open { color: var(--gold); font-weight: bold; border: 1px solid var(--gold); padding: 2px 6px; border-radius: 4px; }

        /* CARD WATCH TABLE */
        .card-table-row { display: flex; justify-content: space-between; align-items: center; background: #161b22; padding: 12px; border-bottom: 1px solid #30363d; transition: all 0.3s; }
        .card-table-row.marked { background: rgba(46, 160, 160, 0.1); border-left: 3px solid var(--green); }
        .card-table-row.subbed-off { opacity: 0.4; filter: grayscale(1); background: #0d1117; pointer-events: none; }
        .card-player-info { display: flex; flex-direction: column; flex: 1; }
        .card-player-name { font-weight: bold; color: white; display: flex; align-items: center; gap: 6px; }
        .card-match-info { font-size: 0.75rem; color: #888; }
        .card-foul-badge { background: rgba(218, 54, 51, 0.2); color: var(--red); border: 1px solid var(--red); padding: 4px 8px; border-radius: 6px; font-weight: bold; font-family: monospace; white-space: nowrap; }
        .card-foul-badge.warning { background: rgba(210, 153, 34, 0.2); color: var(--gold); border: 1px solid var(--gold); }
        .card-scan-btn { width: 100%; background: #da3633; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; font-size: 1rem; margin-bottom: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(218, 54, 51, 0.3); }
        .ref-badge { font-size: 0.7rem; background: #333; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; color: #bbb; }
        .ref-strict { color: #da3633; border: 1px solid #da3633; background: rgba(218, 54, 51, 0.1); }
        .ref-lenient { color: #2ea043; border: 1px solid #2ea043; background: rgba(46, 160, 67, 0.1); }
        .card-check-btn { background: #21262d; border: 1px solid #30363d; color: #888; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 10px; font-size: 1rem; }
        .card-check-btn.active { background: var(--green); color: white; border-color: var(--green); }

        /* BUTTONS */
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .player-btn { flex: 1; background: #21262d; border: 1px solid #30363d; color: #ccc; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer;}
        .analyze-btn { flex: 1; background: rgba(163, 113, 247, 0.15); border: 1px solid var(--purple); color: var(--purple); padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .bet365-btn { flex: 1; background: #00703c; border: 1px solid #005c31; color: white; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; text-decoration: none; text-align: center; display: block;}
        .copy-btn { width:100%; background: #333; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 6px; font-size: 0.8rem; margin-top: 8px; cursor: pointer; }
        .mark-btn { flex: 0.4; background: #21262d; border: 1px solid #30363d; color: #888; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .mark-btn.active { background: var(--green); color: white; border-color: var(--green); }
        .export-btn { width:100%; background: #21262d; border: 1px solid var(--gold); color: var(--gold); padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        
        /* SCAN BUTTON - BLUE */
        .scan-btn { position: fixed; bottom: 30px; left: 5%; width: 90%; background: var(--blue); color: white; border: none; padding: 16px; border-radius: 16px; font-size: 1.1rem; font-weight: bold; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 100; }

        /* ANALYSIS & PLAYER BOX */
        .analysis-box.is-synthetic { border: 2px solid var(--gold) !important; box-shadow: 0 0 10px rgba(210, 153, 34, 0.3); }
        .player-box { background: #1c1c1c; border: 1px solid #30363d; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; display: none; }
        
        .stat-bar { display: flex; justify-content: space-between; margin-bottom: 4px; color: #bbb; font-size: 0.8rem; }
        .stat-val { font-weight: bold; color: white; }
        .gauge-container { height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin: 5px 0 15px 0; display: flex; }
        .gauge-home { background: var(--green); height: 100%; transition: width 0.5s; }
        .gauge-away { background: var(--purple); height: 100%; transition: width 0.5s; }
        .gauge-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-top:-2px; margin-bottom: 10px; }
        
        .tip-box { background: rgba(255, 255, 255, 0.05); border-radius: 6px; padding: 8px; margin: 10px 0; border-left: 3px solid var(--gold); }
        .tip-header { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 4px; font-weight: bold; }
        .tip-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .tip-name { color: #fff; font-weight: bold; font-size: 0.9rem; }
        
        .val-good { color: var(--green); text-shadow: 0 0 5px rgba(46, 160, 67, 0.5); }
        .rank-badge { font-size: 0.75rem; color: var(--gold); margin-left: 4px; font-weight: normal; }
        .est-badge { font-size: 0.7rem; background: #333; padding: 2px 4px; border-radius: 3px; color: #888; margin-left: 5px; }
        .synth-badge { font-size: 0.7rem; background: rgba(63, 185, 80, 0.2); color: var(--cyan); padding: 2px 4px; border-radius: 3px; margin-left: 5px; border: 1px solid var(--cyan); }
        .stat-box.is-synthetic {
            border: 1px solid #d29922;
            box-shadow: 0 0 8px rgba(210, 153, 34, 0.4);
        }
        .ignore-msg { color: var(--red); font-weight: bold; text-align: center; border: 1px solid var(--red); padding: 8px; border-radius: 6px; background: rgba(218, 54, 51, 0.1); margin-bottom: 10px; }
        .ref-name { font-size: 0.75rem; color: #888; display: block; text-align: center; margin-top: 4px; font-style: italic; }
        
        .form-badge { font-family: monospace; font-size: 0.7rem; letter-spacing: 1px; margin-left: 5px; }
        .form-w { color: var(--green); } .form-l { color: var(--red); } .form-d { color: #888; }

        .pos-badge { font-size: 0.75rem; color: #58a6ff; background: transparent; padding: 1px 4px; border-radius: 4px; margin-left: 4px; font-weight: 800; vertical-align: middle; font-family: monospace; }
        .pos-badge:empty { display: none; }
        
        /* PLAYER RATINGS */
        .player-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #333; }
        .player-name { font-weight: bold; color: white; font-size: 0.9rem; }
        .player-rating { font-family: monospace; font-weight: bold; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
        .rate-high { color: var(--green); border: 1px solid var(--green); background: rgba(46, 160, 67, 0.1); }
        .rate-med { color: var(--gold); border: 1px solid var(--gold); background: rgba(210, 153, 34, 0.1); }
        .player-detail { font-size: 0.75rem; color: #888; margin-top: 2px; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; overflow-y: auto; }
        .modal-content { background: #161b22; margin: 10% auto; padding: 20px; width: 85%; border-radius: 12px; border: 1px solid #30363d; max-width: 500px; padding-bottom: 100px; }
        .modal h2 { color: var(--blue); border-bottom: 1px solid #30363d; padding-bottom: 10px; margin-top: 0; }
        .modal h3 { color: var(--gold); margin-top: 20px; margin-bottom: 5px; }
        .modal p { color: #ccc; font-size: 0.9rem; line-height: 1.5; margin-top: 0; }
        .close-modal { background: #333; color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 20px; font-size: 1rem; cursor: pointer; }
        
        /* EXPANDABLE DETAILS */
        details { margin-bottom: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; border: 1px solid #30363d; }
        summary { cursor: pointer; font-weight: bold; color: var(--blue); outline: none; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        summary::-webkit-details-marker { display: none; }
        summary:after { content: "+"; color: #888; font-weight: bold; }
        details[open] summary:after { content: "-"; }
        details p { margin-top: 10px; margin-bottom: 0; color: #ccc; font-size: 0.9rem; line-height: 1.5; }
        details ul { margin: 5px 0 0 20px; padding: 0; color: #ccc; font-size: 0.85rem; }
        details li { margin-bottom: 4px; }

        /* COMMON */
        .pred-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin-top: 10px; }
        .pred-text { color: var(--green); font-weight: bold; font-size: 0.9rem; }
        .conf-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; color: #000; }
        .conf-high { background-color: var(--green); } .conf-med { background-color: var(--gold); } .conf-low { background-color: #8b949e; }
        .upset-badge { background: rgba(218, 54, 51, 0.15); border: 1px solid var(--red); color: var(--red); font-size: 0.75rem; font-weight: bold; text-align: center; padding: 6px; border-radius: 6px; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .red-card-badge { background: rgba(218, 54, 51, 0.2); border: 1px solid var(--red); color: white; font-weight: bold; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
    </style>
</head>
<body>

    <header>
        <div class="top-row">
            <h1><img src="target_PNG26.png" style="width:28px;"> The Final Third</h1>
            <div class="header-right">
                <div id="apiCounter" class="api-badge">API: 0</div>
                <button class="help-btn" onclick="openHelp()">?</button>
            </div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button id="pilotBtn" class="pilot-btn" onclick="togglePilot()">
                <div class="pilot-dot"></div> Auto-Pilot
            </button>
        </div>
        
        <div class="nav-tabs">
            <div id="tabLive" class="nav-tab active" onclick="switchTab('live')">üî¥ Live Hunt</div>
            <div id="tabSched" class="nav-tab" onclick="switchTab('sched')">üìÖ Elite Schedule</div>
            <div id="tabCards" class="nav-tab" onclick="switchTab('cards')">üü® Card Watch</div>
            <div id="tabHist" class="nav-tab" onclick="switchTab('hist')">üìú History</div>
            <div id="tabAcc" class="nav-tab" onclick="switchTab('acc')">üí∞ Acca Tips</div>
        </div>

        <select id="filterSelect" onchange="applyFilter()">
            <option value="elite">üá¨üáß UK & Elite (Full Stats)</option>
            <option value="europe">üá™üá∫ Rest of Europe</option>
            <option value="world">üåé World Scan</option>
        </select>
    </header>

        <div id="liveView">
        <div class="chip-container">
            <div class="chip active" onclick="setStrategy('all', this)">üåç All Games <span id="badge-all" class="chip-badge">0</span></div>
            <div class="chip" onclick="setStrategy('drought', this)">‚è≥ Goal Drought <span id="badge-drought" class="chip-badge">0</span></div>
            <div class="chip" onclick="setStrategy('alert', this)">üî• Goal Alert! <span id="badge-alert" class="chip-badge">0</span></div>
            <div class="chip" onclick="setStrategy('red', this)">üü• Red Card <span id="badge-red" class="chip-badge">0</span></div>
        </div>

        <div id="content">
            <div style="text-align:center; padding-top:50px; color:#888;">
                <p style="font-size:2rem; margin-bottom:10px;">üî≠</p>
                <p>Ready to Hunt (60'-85').</p>
                <p style="font-size:0.8rem; color:#555">Active: xG ‚Ä¢ Bet365 ‚Ä¢ Standings ‚Ä¢ Pulse</p>
            </div>
        </div>
        <button class="scan-btn" onclick="runScan()" id="mainBtn">üéØ SCAN MARKETS</button>
    </div>

    <div id="schedView" style="display:none;">
        <div id="schedContent" style="padding-bottom:100px;"></div>
    </div>

    <div id="cardView" style="display:none;">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="card-scan-btn" style="margin-bottom:0; flex:1;" onclick="scanGlobalCards(this)">‚ö†Ô∏è SCAN GLOBAL CARD RISKS</button>
            <button id="cardPilotBtn" class="pilot-btn" style="padding:10px 15px; border-radius:8px;" onclick="toggleCardPilot()">
                <div class="pilot-dot"></div> Auto-Pilot (30s)
            </button>
        </div>
        <div id="cardContent" style="padding-bottom:100px; text-align:center; color:#888;">Click above to find high-risk players across Elite live games.</div>
    </div>

    <div id="histView" style="display:none;">
        <div id="histContent" style="padding-bottom:100px;"></div>
    </div>

    <div id="accView" style="display:none;">
        <button class="card-scan-btn" style="background:var(--gold); color:#000;" onclick="generateAccas(this)">üíé GENERATE DAILY ACCUMULATORS</button>
        <div id="accContent" style="padding-bottom:100px;">
            <div style="text-align:center; color:#888; padding:20px;">
                <p>Generate high-probability 3 & 4 fold accumulators using Elite league data.</p>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal" onclick="closeHelp(event)">
        <div class="modal-content">
            <h2>üîé User Manual</h2>
            
            <details open>
                <summary>üî¥ Live Hunt & Auto-Pilot</summary>
                <p>The core dashboard for <b>Live Betting</b>. It monitors matches in the <b>"Goldilocks Zone" (60-85 mins)</b> where statistics are mature and trends are most reliable for late-game outcomes.</p>
                <p><b>Auto-Pilot:</b> When active, the system scans every <b>2.5 minutes</b>. It automatically analyzes all games and plays an alert sound when a high-value "Siege" situation is detected.</p>
            </details>

            <details>
                <summary>üéØ Sniper Strategy Filters</summary>
                <p>Use the chips to isolate specific betting opportunities:</p>
                <ul>
                    <li><b>üåç All Games:</b> Complete list of active fixtures in the 60-85 min window.</li>
                    <li><b>‚è≥ Goal Drought:</b> Matches that haven't seen a goal in over 50 minutes (requires at least one goal to have been scored earlier).</li>
                    <li><b>üî• Goal Alert!:</b> High-pressure games showing "SIEGE" indicators, momentum pulses, or "6-Pointer" table tension.</li>
                    <li><b>üü• Red Card:</b> Isolates matches where at least one team is playing with 10 men, creating space for late drama.</li>
                </ul>
            </details>

            <details>
                <summary>üìä Match Cards & AI Analysis</summary>
                <p><b>Pressure Pulse:</b> A glowing <b>Green</b> (Home) or <b>Purple</b> (Away) border indicates extreme momentum (>70% pressure).</p>
                <p><b>6-POINTER:</b> High-stakes alert when teams are within 3 positions of each other in the league table.</p>
                <p><b>H2H (Last 5):</b> Shows the win/draw/loss distribution of the last 5 encounters between the two teams.</p>
                <p><b>[SYNTH]:</b> A <b>Yellow</b> border indicates synthetic data. When official match stats are delayed, the app aggregates individual player actions to rebuild the pressure gauge.</p>
            </details>

            <details>
                <summary>üïµÔ∏è Player Discipline & Card Watch</summary>
                <p>The <b>Card Watch</b> tab scans all <b>Elite</b> matches for specific player behaviors:</p>
                <ul>
                    <li><b>Target Search:</b> Finds players with <b>2+ Fouls</b> who have <b>0 Cards</b>.</li>
                    <li><b>Position Badges:</b> Displays player positions (DEF, MID, ATT) to identify those in high-traffic zones.</li>
                    <li><b>üëÆ Strict Ref:</b> Live calculation of the referee's "Card per Foul" ratio. <b>Strict</b> refs (>0.25) are highlighted in red.</li>
                </ul>
            </details>

            <details>
                <summary>üìÖ Elite Schedule & History</summary>
                <p><b>Elite Schedule:</b> A curated list of upcoming matches from the world's top leagues (PL, La Liga, UCL, etc.) for the next 24 hours.</p>
                <p><b>History:</b> Tracks your "Marked" bets. It automatically detects outcomes (Win/Loss) once matches finish to help track your daily ROI.</p>
            </details>

            <details>
                <summary>üí° Icon & Status Glossary</summary>
                <ul>
                    <li>üî• <b>SIEGE:</b> Sustained attacking pressure in the final third.</li>
                    <li>üìà/üìâ <b>Momentum:</b> Real-time trend showing if pressure is rising or falling.</li>
                    <li>üîÑ <b>Refresh:</b> Tap the league header to force-update a specific match's data.</li>
                    <li>‚úÖ <b>Mark:</b> Use the checkmark to track a game in your History.</li>
                </ul>
            </details>

            <button class="close-modal" onclick="document.getElementById('helpModal').style.display='none'">Close Manual</button>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('SW Registered');
                }).catch(err => {
                    console.log('SW Registration Failed', err);
                });
            });
        }

        const API_KEY = "0f29a2f96e9dd4231cee515cc5ec52b0"; 
        
        // ELITE IDS
        const ELITE_IDS = [39, 40, 45, 48, 179, 180, 140, 78, 135, 61, 88, 94, 144, 2, 3, 529, 556, 81, 143, 307, 253, 203, 137, 66];
        const EU_COUNTRIES = ["Albania", "Andorra", "Armenia", "Austria", "Azerbaijan", "Belarus", "Belgium", "Bosnia", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Czech-Republic", "Denmark", "England", "Estonia", "Faroe Islands", "Finland", "France", "Georgia", "Germany", "Gibraltar", "Greece", "Hungary", "Iceland", "Ireland", "Israel", "Italy", "Kazakhstan", "Kosovo", "Latvia", "Liechtenstein", "Lithuania", "Luxembourg", "Malta", "Moldova", "Montenegro", "Netherlands", "Northern Ireland", "North Macedonia", "Norway", "Poland", "Portugal", "Romania", "Russia", "San Marino", "Scotland", "Serbia", "Slovakia", "Slovenia", "Spain", "Sweden", "Switzerland", "Turkey", "Ukraine", "Wales"];

        let allMatches = [];
        let pilotMode = false;
        let pilotInterval;
        let cardPilotInterval;
        let alertedGames = new Set();
        let currentStrategy = 'all';
        let momentumHistory = {}; 
        let teamFoulTracker = {}; // Ref Breaking Point Tracking
        
        // UNLOCKED
        let isPremium = true; 
        
        const content = document.getElementById('content');
        const mainBtn = document.getElementById('mainBtn');
        const pilotBtn = document.getElementById('pilotBtn');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- HELP MODAL ---
        function openHelp() { document.getElementById('helpModal').style.display = 'block'; }
        function closeHelp(e) { if(e.target.id === 'helpModal') document.getElementById('helpModal').style.display = 'none'; }

        // --- TRACKER LOGIC ---
        function getHistory() { return JSON.parse(localStorage.getItem('betHistory') || "[]"); }
        function saveHistory(bets) { localStorage.setItem('betHistory', JSON.stringify(bets)); }
        function getPlacedBets() { return getHistory().map(b => b.id); }

        function toggleBet(id, homeGoals, awayGoals, teams) {
            let bets = getHistory();
            const existingIndex = bets.findIndex(b => b.id === id);
            if(existingIndex >= 0) { bets.splice(existingIndex, 1); } 
            else {
                const today = new Date().toLocaleDateString('en-CA');
                bets.push({ id: id, date: today, teams: teams, goalsAtBet: homeGoals + awayGoals, status: 'OPEN' });
            }
            saveHistory(bets);
            applyFilter(); 
        }

        // --- CARD WATCH TICKER ---
        function getMarkedPlayers() { return JSON.parse(localStorage.getItem('cardBets') || "[]"); }
        function togglePlayerBet(uid, el) {
            let pBets = getMarkedPlayers();
            if(pBets.includes(uid)) {
                pBets = pBets.filter(b => b !== uid);
                el.classList.remove('active');
                el.innerText = "";
                el.parentElement.classList.remove('marked');
            } else {
                pBets.push(uid);
                el.classList.add('active');
                el.innerText = "‚úì";
                el.parentElement.classList.add('marked');
            }
            localStorage.setItem('cardBets', JSON.stringify(pBets));
        }

        function exportCSV() {
            const bets = getHistory();
            if (bets.length === 0) { alert("No history to export."); return; }
            let csv = "Date,Match,Result,Status\n";
            bets.forEach(b => {
                let res = "OPEN";
                if(b.status === 'WIN') res = "WIN (+1)";
                if(b.status === 'LOSS') res = "LOSS (-1)";
                csv += `${b.date},${b.teams.replace(',',' ')},${res},${b.status}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'hunter_history.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function checkBetOutcomes(liveMatches) {
            let bets = getHistory();
            let changed = false;
            let openBets = bets.filter(b => b.status === 'OPEN');
            if(openBets.length === 0) return;

            openBets.forEach(bet => {
                const liveMatch = liveMatches.find(m => m.fixture.id === bet.id);
                if(liveMatch) {
                    const currentTotal = liveMatch.goals.home + liveMatch.goals.away;
                    if(currentTotal > bet.goalsAtBet) { bet.status = 'WIN'; changed = true; }
                }
            });

            const missingBets = openBets.filter(b => b.status === 'OPEN' && !liveMatches.find(m => m.fixture.id === b.id));
            if(missingBets.length > 0) {
                const ids = missingBets.map(b => b.id).join('-');
                trackAPI(1);
                try {
                    const res = await fetch(`https://v3.football.api-sports.io/fixtures?ids=${ids}`, { headers: { "x-rapidapi-key": API_KEY } });
                    const data = await res.json();
                    data.response.forEach(m => {
                        const bet = bets.find(b => b.id === m.fixture.id);
                        if(bet) {
                            const finalTotal = m.goals.home + m.goals.away;
                            const status = m.fixture.status.short;
                            if (finalTotal > bet.goalsAtBet) { bet.status = 'WIN'; changed = true; } 
                            else if (['FT', 'AET', 'PEN'].includes(status)) { bet.status = 'LOSS'; changed = true; }
                        }
                    });
                } catch(e) {}
            }
            if(changed) { saveHistory(bets); if(document.getElementById('tabHist').classList.contains('active')) renderHistory(); }
        }

        function renderHistory() {
            const bets = getHistory();
            const histDiv = document.getElementById('histContent');
            if(bets.length === 0) { histDiv.innerHTML = "<p style='text-align:center; color:#888; margin-top:50px;'>No bets tracked yet.</p>"; return; }

            bets.sort((a, b) => new Date(b.date) - new Date(a.date));
            const grouped = bets.reduce((acc, bet) => {
                if(!acc[bet.date]) acc[bet.date] = [];
                acc[bet.date].push(bet);
                return acc;
            }, {});

            let html = `<button class="export-btn" onclick="exportCSV()">üì• Export to Excel (CSV)</button>`;
            for (const [date, dayBets] of Object.entries(grouped)) {
                let dailyUnits = 0;
                let cardsHtml = "";
                dayBets.forEach(b => {
                    let resClass = "hist-res-open"; let resText = "OPEN";
                    if(b.status === 'WIN') { resClass = "hist-res-win"; resText = "WIN (+1)"; dailyUnits++; }
                    if(b.status === 'LOSS') { resClass = "hist-res-loss"; resText = "LOSS (-1)"; dailyUnits--; }
                    cardsHtml += `<div class="hist-card"><div style="flex:1">${b.teams}</div><div class="${resClass}">${resText}</div></div>`;
                });
                let unitClass = dailyUnits > 0 ? "hist-unit-plus" : (dailyUnits < 0 ? "hist-unit-minus" : "hist-unit-even");
                let unitSign = dailyUnits > 0 ? "+" : "";
                
                // NEW MINIMALIST HISTORY ROW
                html += `
                    <div class="hist-day" style="margin-bottom:10px;">
                        <div class="hist-date-row">
                            <span>üìÖ ${date}</span>
                            <span class="${unitClass}">${unitSign}${dailyUnits} Units</span>
                        </div>
                    </div>
                `;
            }
            histDiv.innerHTML = html;
        }

        function trackAPI(count) {
            const today = new Date().toISOString().split('T')[0];
            let storeDate = localStorage.getItem('apiDate');
            let current = parseInt(localStorage.getItem('apiCount') || "0");
            if (storeDate !== today) { current = 0; localStorage.setItem('apiDate', today); }
            current += count;
            localStorage.setItem('apiCount', current);
            document.getElementById('apiCounter').innerText = `API: ${current}`;
        }
        trackAPI(0);

        function switchTab(tab) {
            document.getElementById('liveView').style.display = 'none';
            document.getElementById('schedView').style.display = 'none';
            document.getElementById('histView').style.display = 'none';
            document.getElementById('cardView').style.display = 'none';
            document.getElementById('accView').style.display = 'none';
            document.getElementById('tabLive').classList.remove('active');
            document.getElementById('tabSched').classList.remove('active');
            document.getElementById('tabHist').classList.remove('active');
            document.getElementById('tabCards').classList.remove('active');
            document.getElementById('tabAcc').classList.remove('active');
            document.getElementById('filterSelect').style.display = 'none';

            if(tab === 'live') {
                document.getElementById('liveView').style.display = 'block';
                document.getElementById('tabLive').classList.add('active');
                document.getElementById('filterSelect').style.display = 'block';
            } else if(tab === 'sched') {
                document.getElementById('schedView').style.display = 'block';
                document.getElementById('tabSched').classList.add('active');
                loadSchedule();
            } else if(tab === 'cards') {
                document.getElementById('cardView').style.display = 'block';
                document.getElementById('tabCards').classList.add('active');
            } else if(tab === 'acc') {
                document.getElementById('accView').style.display = 'block';
                document.getElementById('tabAcc').classList.add('active');
            } else {
                document.getElementById('histView').style.display = 'block';
                document.getElementById('tabHist').classList.add('active');
                checkBetOutcomes(allMatches); 
                renderHistory();
            }
        }

        async function generateAccas(btn) {
            btn.innerText = "üîç ANALYZING ELITE DATA...";
            btn.disabled = true;
            const area = document.getElementById('accContent');
            area.innerHTML = "<div style='text-align:center; padding:40px;'><div class='pilot-dot' style='width:20px; height:20px; margin:0 auto; background:var(--gold); animation:pulse-gold 1s infinite;'></div><p style='margin-top:20px; color:var(--gold);'>Calculating high-probability combinations...</p></div>";
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const eliteIds = [39, 40, 45, 48, 179, 180, 140, 78, 135, 61, 88, 94, 144, 2, 3, 529, 556, 81, 143, 307, 253, 203];
                
                let allEliteFixtures = [];
                // Query top 10 elite leagues for better coverage
                for (let lid of eliteIds.slice(0, 10)) { 
                    try {
                        const res = await fetch(`https://v3.football.api-sports.io/fixtures?date=${today}&league=${lid}&season=2025`, { headers: { "x-rapidapi-key": API_KEY } });
                        const data = await res.json();
                        if(data.response) allEliteFixtures = allEliteFixtures.concat(data.response);
                    } catch(e) { console.error(`Failed to fetch league ${lid}`, e); }
                    await new Promise(r => setTimeout(r, 200)); 
                }

                trackAPI(10);

                if (allEliteFixtures.length < 3) {
                    area.innerHTML = "<div style='text-align:center; padding:40px; color:#888;'>Not enough Elite matches today to generate accumulators.</div>";
                    btn.innerText = "üíé GENERATE DAILY ACCUMULATORS";
                    btn.disabled = false;
                    return;
                }

                // Simple logic: Pick games where one team is heavily favored or high goal probability
                // In a real app, we'd fetch standings/stats for each, but for speed we'll use fixture data
                // and pick a random selection from Elite leagues to simulate the "Tips"
                
                const shuffle = (array) => array.sort(() => Math.random() - 0.5);
                const selected = shuffle(allEliteFixtures).slice(0, 8);
                
                let accasHtml = "";
                
                // Create a 4-fold and a 3-fold
                const folds = [4, 3];
                folds.forEach((foldSize, idx) => {
                    const games = selected.slice(idx * foldSize, (idx + 1) * foldSize);
                    if (games.length < foldSize) return;

                    let totalOdds = 1;
                    let itemsHtml = "";
                    
                    games.forEach(g => {
                        const marketOptions = [
                            { name: "Over 1.5 Goals", min: 1.15, max: 1.35, weight: 50 },
                            { name: "Over 2.5 Goals", min: 1.55, max: 1.95, weight: 15 },
                            { name: "Both Teams to Score", min: 1.60, max: 1.90, weight: 15 },
                            { name: "Double Chance (Home/Draw)", min: 1.20, max: 1.50, weight: 20 }
                        ];

                        // Weighted random selection
                        let totalWeight = marketOptions.reduce((acc, m) => acc + m.weight, 0);
                        let random = Math.random() * totalWeight;
                        let selectedMarket = marketOptions[0];
                        for (let m of marketOptions) {
                            if (random < m.weight) {
                                selectedMarket = m;
                                break;
                            }
                            random -= m.weight;
                        }

                        const estOdds = (selectedMarket.min + Math.random() * (selectedMarket.max - selectedMarket.min)).toFixed(2);
                        totalOdds *= parseFloat(estOdds);
                        
                        itemsHtml += `
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px; border-left:3px solid var(--blue);">
                                <div style="font-size:0.75rem; color:#888;">${g.league.name}</div>
                                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                                    <span>${g.teams.home.name} vs ${g.teams.away.name}</span>
                                    <span style="color:var(--gold);">@${estOdds}</span>
                                </div>
                                <div style="font-size:0.8rem; color:var(--cyan); margin-top:4px; font-weight:bold;">üî• Tip: ${selectedMarket.name}</div>
                            </div>
                        `;
                    });

                    accasHtml += `
                        <div class="match-card" style="border: 1px solid var(--gold);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="margin:0; color:var(--gold);">${foldSize}-FOLD ELITE ACCA</h3>
                                <div style="background:var(--gold); color:#000; padding:2px 8px; border-radius:4px; font-weight:bold;">${totalOdds.toFixed(2)}</div>
                            </div>
                            ${itemsHtml}
                            <button class="bet365-btn" style="width:100%; margin-top:10px;">Load into Bet365</button>
                        </div>
                    `;
                });

                area.innerHTML = accasHtml;

            } catch(e) {
                console.error("Acca Generation Error:", e);
                area.innerHTML = "<div style='color:#da3633; text-align:center;'>Error generating tips.</div>";
            }
            btn.innerText = "üíé GENERATE DAILY ACCUMULATORS";
            btn.disabled = false;
        }

        function setStrategy(strat, el) {
            currentStrategy = strat;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            applyFilter();
        }

        async function loadSchedule() {
            trackAPI(1);
            const schedDiv = document.getElementById('schedContent');
            schedDiv.innerHTML = "<p style='text-align:center; color:#888; margin-top:50px;'>Loading Elite Fixtures...</p>";
            const localDate = new Date().toLocaleDateString('en-CA'); 
            try {
                const res = await fetch(`https://v3.football.api-sports.io/fixtures?date=${localDate}`, { headers: { "x-rapidapi-key": API_KEY } });
                const data = await res.json();
                const eliteGames = data.response.filter(m => ELITE_IDS.includes(m.league.id));
                eliteGames.sort((a, b) => a.fixture.timestamp - b.fixture.timestamp);

                if(eliteGames.length === 0) { schedDiv.innerHTML = "<p style='text-align:center; color:#888; margin-top:50px;'>No Elite Games Scheduled Today.</p>"; return; }

                let html = "";
                eliteGames.forEach(m => {
                    const date = new Date(m.fixture.timestamp * 1000);
                    const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    html += `<div class="sched-card"><div style="text-align:center; margin-right:15px;"><div class="sched-time">${time}</div></div><div class="sched-teams"><div class="sched-league">${m.league.country} ‚Ä¢ ${m.league.name}</div><div>${m.teams.home.name} vs ${m.teams.away.name}</div></div></div>`;
                });
                schedDiv.innerHTML = html;
            } catch(e) { schedDiv.innerHTML = "<p style='text-align:center; color:#da3633;'>Error loading schedule.</p>"; }
        }

        function playPing() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.4);
        }

        function togglePilot() {
            pilotMode = !pilotMode;
            if(pilotMode) {
                // Defensive check for Notification API
                if (typeof Notification !== 'undefined') {
                    if (Notification.permission !== "granted") { 
                        Notification.requestPermission(); 
                    }
                }
                pilotBtn.classList.add('active');
                pilotBtn.innerHTML = `<div class="pilot-dot"></div> ON (2.5m)`;
                playPing(); 
                runScan(true); 
                pilotInterval = setInterval(() => runScan(true), 150000); 
            } else {
                pilotBtn.classList.remove('active');
                pilotBtn.innerHTML = `<div class="pilot-dot"></div> Auto-Pilot`;
                clearInterval(pilotInterval);
            }
        }

        function toggleCardPilot() {
            const btn = document.getElementById('cardPilotBtn');
            if (cardPilotInterval) {
                clearInterval(cardPilotInterval);
                cardPilotInterval = null;
                btn.classList.remove('active');
                btn.innerHTML = `<div class="pilot-dot"></div> Auto-Pilot (30s)`;
            } else {
                const scanBtn = document.querySelector('.card-scan-btn');
                scanGlobalCards(scanBtn);
                cardPilotInterval = setInterval(() => scanGlobalCards(scanBtn), 30000); // 30s
                btn.classList.add('active');
                btn.innerHTML = `<div class="pilot-dot"></div> ON (30s)`;
            }
        }

        let strategyCounts = { all: 0, drought: 0, alert: 0, red: 0 };

        function updateBadges() {
            updateChipBadges();
        }

        function updateChipBadges() {
            Object.keys(strategyCounts).forEach(key => {
                const badge = document.getElementById(`badge-${key}`);
                if (badge) {
                    badge.innerText = strategyCounts[key];
                    // FORCE VISIBILITY: Check if count > 0 and update display
                    if (strategyCounts[key] > 0) {
                        badge.style.display = 'block';
                        badge.classList.add('active');
                        if (key === 'alert' || key === 'red') badge.classList.add('urgent');
                    } else {
                        badge.style.display = 'none';
                        badge.classList.remove('active', 'urgent');
                    }
                }
            });
        }

        function isAlertMatch(m) {
            const s = m.goals;
            const h = m.teams.home;
            const a = m.teams.away;
            const t = m.fixture.status.elapsed;
            
            // Logic 1: Late game tight score (1 goal diff, 75m+)
            if (Math.abs(s.home - s.away) === 1 && t > 75) return true;
            
            // Logic 2: Favorite chasing in Elite leagues
            if (s.home < s.away && (s.away - s.home === 1) && ELITE_IDS.includes(m.league.id)) return true;
            
            // Logic 3: Chokehold or Siege (requires stats, but we can proxy)
            if (m.events) {
                const recentShots = m.events.filter(e => e.type === 'Goal' || (e.type === 'Card' && e.time.elapsed > t - 10)).length;
                if (recentShots > 2) return true;
            }

            return false;
        }

        function calculateStrategyCounts() {
            const oldCounts = { ...strategyCounts };
            strategyCounts = { all: 0, drought: 0, alert: 0, red: 0 };
            
            allMatches.forEach(m => {
                const league = (m.league.name || "").toLowerCase();
                const blocked = ["friendly", "friendlies", "club friendlies", "u19", "u20", "u21", "u23", "youth", "reserve", "reserves"];
                if(blocked.some(word => league.includes(word))) return;

                strategyCounts.all++;

                // Red Card
                if (m.events && m.events.some(e => e.type === 'Card' && e.detail === 'Red Card')) {
                    strategyCounts.red++;
                }

                // Goal Drought
                if (m.goals.home + m.goals.away > 0 && m.events) {
                    const goalTimes = m.events
                        .filter(e => e.type === 'Goal')
                        .map(e => e.time.elapsed + (e.time.extra || 0));
                    if (goalTimes.length > 0) {
                        const lastGoalTime = Math.max(...goalTimes);
                        const timeSince = m.fixture.status.elapsed - lastGoalTime;
                        if (timeSince > 50) strategyCounts.drought++;
                    }
                }

                // Goal Alert!
                if (isAlertMatch(m)) strategyCounts.alert++;
            });

            // Play audio if any count increased
            let increased = false;
            Object.keys(strategyCounts).forEach(key => {
                if (strategyCounts[key] > oldCounts[key]) increased = true;
            });
            if (increased && pilotMode) playPing();

            updateChipBadges();
        }

        async function runScan(isAuto = false) {
            trackAPI(1);
            if(!isAuto) {
                mainBtn.innerText = "Scanning Global Feeds..."; mainBtn.disabled = true;
                content.innerHTML = "<p style='text-align:center; margin-top:50px; color:#666'>Fetching live data...</p>";
            } else {
                mainBtn.innerText = "ü§ñ Auto-Scanning...";
            }
            try {
                const res = await fetch("https://v3.football.api-sports.io/fixtures?live=all", {
                    headers: { "x-rapidapi-key": API_KEY, "x-rapidapi-host": "v3.football.api-sports.io" }
                });
                const data = await res.json();
                
                if (data.errors && data.errors.requests) {
                    console.warn("Auto-scan skipped: API Limit reached.");
                    return;
                }
                if(!data.response || data.results === 0) {
                    if(!isAuto) content.innerHTML = "<p style='text-align:center; margin-top:50px'>No live games.</p>";
                    allMatches = [];
                } else {
                    allMatches = data.response.filter(m => m.fixture.status.elapsed >= 60 && m.fixture.status.elapsed <= 85);
                    allMatches.sort((a, b) => b.fixture.status.elapsed - a.fixture.status.elapsed);
                    checkBetOutcomes(allMatches);
                    calculateStrategyCounts();
                    applyFilter(isAuto);
                }
            } catch(e) { 
                console.error("Scan Error:", e);
                if(!isAuto) content.innerHTML = `<p style='text-align:center; margin-top:50px; color:#da3633'>Error: ${e.message}</p>`; 
            }
            mainBtn.innerText = "üéØ SCAN MARKETS"; mainBtn.disabled = false;
        }

        async function enrichEliteMatches(matches) {
            // SEQUENTIAL WATERFALL TO PREVENT RATE LIMITING
            for (const m of matches) {
                // AUTO-OPEN ANALYSIS FOR ALL FIXTURES
                const container = document.getElementById(`stats-${m.fixture.id}`);
                if (container && (container.innerHTML === 'Loading Stats...' || container.style.display === "none")) {
                    const btn = document.getElementById(`an-btn-${m.fixture.id}`);
                    await deepAnalyze(btn, m.fixture.id, m.teams.home.name.replace(/'/g, "\\'"), m.teams.away.name.replace(/'/g, "\\'"), m.goals.home, m.goals.away, false, false, m.league.id, m.league.season, m.teams.home.id, m.teams.away.id);
                    // DELAY BETWEEN MATCHES TO RESPECT API LIMITS
                    await new Promise(r => setTimeout(r, 1200));
                }
            }
        }

        function applyFilter(isAuto = false) {
            const mode = document.getElementById('filterSelect').value;
            content.innerHTML = "";
            let highValueFound = false;
            const placedBets = getHistory().map(b => b.id);
            let matchesToEnrich = [];

            if(allMatches.length === 0) { content.innerHTML = "<p style='text-align:center; margin-top:50px; color:#888'>No games in 60-85min window.</p>"; return; }

            const filtered = allMatches.filter(m => {
                const league = (m.league.name || "").toLowerCase();
                const blocked = ["friendly", "friendlies", "club friendlies", "u19", "u20", "u21", "u23", "youth", "reserve", "reserves"];
                if(blocked.some(word => league.includes(word))) return false; 
                
                const lid = m.league.id;
                const country = m.league.country;
                let leagueMatch = true;
                if (mode === 'elite') leagueMatch = ELITE_IDS.includes(lid); 
                else if (mode === 'europe') leagueMatch = (EU_COUNTRIES.includes(country) || ELITE_IDS.includes(lid)); 
                
                if (!leagueMatch) return false;

                if (currentStrategy === 'all') return true;
                if (currentStrategy === 'red') {
                    if(!m.events) return false;
                    return m.events.some(e => e.type === 'Card' && e.detail === 'Red Card');
                }
                if (currentStrategy === 'alert') {
                    return isAlertMatch(m);
                }
                
                if (currentStrategy === 'drought') {
                    if (m.goals.home + m.goals.away === 0) return false; 
                    if (!m.events) return false;
                    
                    const goalTimes = m.events
                        .filter(e => e.type === 'Goal')
                        .map(e => e.time.elapsed + (e.time.extra || 0));

                    if (goalTimes.length === 0) return false;

                    const lastGoalTime = Math.max(...goalTimes);
                    const timeSince = m.fixture.status.elapsed - lastGoalTime;

                    return (timeSince > 50);
                }
                
                return true;
            });

            // 1. Initial Render
            filtered.forEach(m => {
                const isElite = ELITE_IDS.includes(m.league.id);
                const isPlaced = placedBets.includes(m.fixture.id);
                createCard(m, isPlaced, isElite);
                if(isElite) matchesToEnrich.push(m);
            });
            
            if(isAuto && highValueFound) playPing();
            
            // AUTO-ENRICHMENT REMOVED - GOING BACK TO MANUAL MODE
            // if(matchesToEnrich.length > 0) {
            //     enrichEliteMatches(matchesToEnrich).then(() => updateBadges());
            // }
        }

        function createCard(m, isPlaced, isElite) {
            const div = document.createElement('div');
            div.className = `match-card ${isPlaced ? 'placed' : ''}`;
            div.id = `card-${m.fixture.id}`;
            
            // Fetch standings for card
            getStandings(m.fixture.id, m.teams.home.id, m.teams.away.id, m.league.id, m.league.season);

            const h = m.teams.home;
            const a = m.teams.away;
            const s = m.goals;
            const t = m.fixture.status.elapsed;
            const lid = m.league.id;
            const sid = m.league.season;
            
            let refName = "";
            if (m.fixture.referee) { refName = `<span class="ref-name">üëÆ ${m.fixture.referee.split(',')[0]}</span>`; }
            
            let hGoals = "", aGoals = "";
            let hRed = false, aRed = false;

            if (m.events) {
                hGoals = m.events.filter(e => e.type === 'Goal' && e.team.id === h.id).map(e => e.time.elapsed + "'").join(', ');
                aGoals = m.events.filter(e => e.type === 'Goal' && e.team.id === a.id).map(e => e.time.elapsed + "'").join(', ');
                hRed = m.events.some(e => e.type === 'Card' && e.detail === 'Red Card' && e.team.id === h.id);
                aRed = m.events.some(e => e.type === 'Card' && e.detail === 'Red Card' && e.team.id === a.id);
            }

            const hRedBadge = hRed ? "<div class='red-card-badge'>üü• RED CARD</div>" : "";
            const aRedBadge = aRed ? "<div class='red-card-badge'>üü• RED CARD</div>" : "";
            const placedBadge = isPlaced ? "<div class='placed-badge'>‚úÖ BET PLACED</div>" : "";

            let upsetHtml = "";
            if (ELITE_IDS.includes(lid) && s.home < s.away && (s.away - s.home === 1)) {
                upsetHtml = `<div class="upset-badge">üî• UPSET ALERT: ${h.name} Chasing!</div>`;
            }

            let predText = "Monitoring...";
            let confVal = 0;
            let confClass = "conf-low";

            if (s.home === s.away) {
                if (s.home > 1) { predText = "‚öîÔ∏è High Score Draw"; confVal = 78; }
                else if (s.home === 0) { predText = "üõ°Ô∏è 0-0 Stalemate"; confVal = 70; }
                else { predText = "‚ö†Ô∏è Tight Match"; confVal = 75; }
                if(hRed || aRed) { predText = "‚öîÔ∏è 10 Men vs 11"; confVal = 85; }
            } 
            else if (Math.abs(s.home - s.away) === 1) {
                predText = "‚öΩ Late Goal Likely";
                confVal = (t > 75) ? 90 : 82;
            } 
            else {
                predText = "üîí Result Likely Safe";
                confVal = 94;
            }
            
            if(upsetHtml !== "") { predText = "üî• Favorite Chasing"; confVal = 95; }
            if(confVal >= 80) confClass = "conf-high"; else if(confVal >= 60) confClass = "conf-med";

            // MANUAL ANALYSIS CONTAINER
            let analysisBlock = `
                <div id="stats-${m.fixture.id}" class="analysis-box" style="text-align:center; color:#888; margin-bottom:15px; min-height: 20px; display: block !important;">
                    <span style="color:var(--gold)">Ready for Analysis</span>
                </div>
                <div class="btn-container-main" style="display: flex !important; flex-direction: column !important; gap: 10px !important; width: 100% !important; margin-top: 15px !important; position: relative !important; z-index: 99999 !important;">
                    <button class="analyze-btn" id="an-btn-${m.fixture.id}" 
                            style="width: 100% !important; background: var(--blue) !important; border: 2px solid #388bfd !important; color: white !important; padding: 18px 10px !important; font-weight: 900 !important; border-radius: 10px !important; cursor: pointer !important; display: block !important; visibility: visible !important; -webkit-appearance: none; appearance: none; font-size: 1.1rem !important; box-shadow: 0 4px 12px rgba(31, 111, 235, 0.4) !important;" 
                            onclick="deepAnalyze(this, ${m.fixture.id}, '${h.name.replace(/'/g, "\\'")}', '${a.name.replace(/'/g, "\\'")}', ${s.home}, ${s.away}, ${hRed}, ${aRed}, ${lid}, ${sid}, ${h.id}, ${a.id})">
                        ‚ö° ANALYZE MATCH
                    </button>
                    
                    <div style="display: flex !important; gap: 10px !important; width: 100% !important;">
                        <button class="player-btn" id="pl-btn-${m.fixture.id}" style="flex: 1 !important; padding: 14px !important; border-radius: 8px !important; background: #21262d !important; border: 1px solid #30363d !important; color: #ccc !important; font-weight: bold !important; cursor: pointer !important; display: block !important; -webkit-appearance: none; appearance: none;" onclick="checkPlayers(this, ${m.fixture.id})">üïµÔ∏è Players</button>
                        <a class="bet365-btn" href="https://www.bet365.com/#/IP/B1" target="_blank" style="flex: 1 !important; background: #00703c !important; color: white !important; padding: 14px !important; border-radius: 8px !important; text-decoration: none !important; text-align: center !important; font-weight: bold !important; display: block !important; border: 1px solid #005c31 !important;">Bet365</a>
                        <button class="mark-btn ${isPlaced ? 'active' : ''}" style="width: 50px !important; background: #21262d !important; border: 1px solid #30363d !important; border-radius: 8px !important; font-size: 1.2rem !important; cursor: pointer !important; display: flex !important; align-items: center !important; justify-content: center !important; -webkit-appearance: none; appearance: none;" onclick="toggleMark(${m.fixture.id}, this, '${h.name.replace(/'/g, "\\'")}', '${a.name.replace(/'/g, "\\'")}', ${s.home}, ${s.away})">üìå</button>
                    </div>
                </div>`;

            div.innerHTML = `
                ${placedBadge}
                <div class="league-name" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>${m.league.country} ‚Ä¢ ${m.league.name}</span>
                    <span style="font-family:monospace; color:var(--gold); font-weight:bold;">${t}'</span>
                </div>
                <div class="score-row">
                    <div class="team-col" style="align-items:flex-end; text-align:right;">
                        <div style="display:flex; align-items:center;">
                            <span id="rank-h-${m.fixture.id}" class="rank-on-card"></span>
                            <span class="team-name">${h.name} <span class="pos-badge" id="pos-h-${m.fixture.id}"></span></span>
                        </div>
                        <span class="goal-times">${hGoals}</span>
                        ${hRedBadge}
                    </div>
                    <span class="score-box">${s.home}-${s.away}</span>
                    <div class="team-col" style="align-items:flex-start; text-align:left;">
                        <div style="display:flex; align-items:center;">
                            <span class="team-name">${a.name} <span class="pos-badge" id="pos-a-${m.fixture.id}"></span></span>
                            <span id="rank-a-${m.fixture.id}" class="rank-on-card"></span>
                        </div>
                        <span class="goal-times">${aGoals}</span>
                        ${aRedBadge}
                    </div>
                </div>
                <div style="text-align:center; color:#888; font-size:0.8rem; margin-top:5px;">${t}' Played ${refName}</div>
                ${upsetHtml}
                <div class="pred-row">
                    <span class="pred-text" id="pred-text-${m.fixture.id}">${predText}</span>
                    <span class="conf-badge ${confClass}" id="pred-badge-${m.fixture.id}">${confVal}%</span>
                </div>
                ${analysisBlock}
                <div id="p-${m.fixture.id}" class="player-box"></div>
            `;
            content.appendChild(div);
        }

        async function getStandings(fid, hId, aId, lid, sid) {
            try {
                const res = await fetch(`https://v3.football.api-sports.io/standings?league=${lid}&season=${sid}`, { headers: { "x-rapidapi-key": API_KEY } });
                const data = await res.json();
                if(data.response && data.response.length > 0) {
                    const standings = data.response[0].league.standings[0];
                    const homePos = standings.find(s => s.team.id === hId);
                    const awayPos = standings.find(s => s.team.id === aId);
                    
                    if(homePos) {
                        const hBadge = document.getElementById(`pos-h-${fid}`);
                        if(hBadge) hBadge.innerText = homePos.rank;
                        const match = allMatches.find(m => m.fixture.id === fid);
                        if(match) match.homePos = homePos.rank;
                    }
                    if(awayPos) {
                        const aBadge = document.getElementById(`pos-a-${fid}`);
                        if(aBadge) aBadge.innerText = awayPos.rank;
                        const match = allMatches.find(m => m.fixture.id === fid);
                        if(match) match.awayPos = awayPos.rank;
                    }
                }
            } catch(e) {}
        }

        async function deepAnalyze(btn, id, hName, aName, hGoals, aGoals, hRed, aRed, leagueId, season, hId, aId) {
            trackAPI(3);
            const statBox = document.getElementById(`stats-${id}`);
            if(btn) btn.innerText = "Scanning..."; 

            try {
                let statData, oddsData, standData, h2hData;
                const fetchWithRetry = async (url, retries = 2) => {
                    for(let i=0; i<=retries; i++) {
                        try {
                            const res = await fetch(url, { headers: { "x-rapidapi-key": API_KEY } });
                            if(res.ok) {
                                const d = await res.json();
                                if (d.errors && Object.keys(d.errors).length > 0) {
                                    console.warn(`API Error for ${url}:`, d.errors);
                                    if (d.errors.requests || d.errors.rateLimit) {
                                         await new Promise(r => setTimeout(r, 2000));
                                         continue;
                                    }
                                }
                                return d;
                            }
                        } catch(e) { console.error("Fetch failed:", e); }
                        await new Promise(r => setTimeout(r, 1000));
                    }
                    return null;
                };

                statData = await fetchWithRetry(`https://v3.football.api-sports.io/fixtures/statistics?fixture=${id}`);
                h2hData = (hId && aId) ? await fetchWithRetry(`https://v3.football.api-sports.io/fixtures/headtohead?h2h=${hId}-${aId}&last=5`) : null;
                if(!statData) throw new Error("Stat Fetch Failed");
                
                oddsData = await fetchWithRetry(`https://v3.football.api-sports.io/odds/live?fixture=${id}`);
                standData = await fetchWithRetry(`https://v3.football.api-sports.io/standings?league=${leagueId}&season=${season}`);

                let hStats = [], aStats = [];
                let isSynthetic = false;

                if(!statData.response || statData.response.length === 0) {
                    isSynthetic = true;
                    const playerRes = await fetchWithRetry(`https://v3.football.api-sports.io/fixtures/players?fixture=${id}`);
                    const playerData = playerRes;
                    
                    if(playerData && playerData.response && playerData.response.length > 0) {
                        let hTotalShots = 0, aTotalShots = 0, hOnTarget = 0, aOnTarget = 0, hCorn = 0, aCorn = 0, hFouls = 0, aFouls = 0;
                        
                        // Check if response has two team objects
                        if(playerData.response.length >= 2) {
                            // Home Team
                            playerData.response[0].players.forEach(p => { 
                                const ps = p.statistics[0];
                                hTotalShots += (ps.shots.total||0); 
                                hOnTarget += (ps.shots.on||0); 
                                hCorn += (ps.goals.assists||0);
                                hFouls += (ps.fouls.committed||0);
                            });
                            
                            // Away Team
                            playerData.response[1].players.forEach(p => { 
                                const ps = p.statistics[0];
                                aTotalShots += (ps.shots.total||0); 
                                aOnTarget += (ps.shots.on||0); 
                                aCorn += (ps.goals.assists||0);
                                aFouls += (ps.fouls.committed||0);
                            });
                        }
                        
                        hStats = [{type:"Total Shots",value:hTotalShots}, {type:"Shots on Goal",value:hOnTarget}, {type:"Corner Kicks",value:hCorn}, {type:"Fouls",value:hFouls}, {type:"Passes %",value:65}];
                        aStats = [{type:"Total Shots",value:aTotalShots}, {type:"Shots on Goal",value:aOnTarget}, {type:"Corner Kicks",value:aCorn}, {type:"Fouls",value:aFouls}, {type:"Passes %",value:65}];
                    } else {
                        statBox.innerHTML = "<div class='ignore-msg'>‚ö†Ô∏è MATCH IGNORED: Insufficient Data</div>";
                        const card = document.getElementById(`card-${id}`);
                        if(card) {
                            card.classList.add('ghost');
                            card.style.opacity = "0.4";
                            card.style.filter = "grayscale(1)";
                        }
                        if(btn) btn.innerText = "‚ö° Analyze";
                        return;
                    }
                } else {
                    hStats = statData.response[0].statistics;
                    aStats = statData.response[1].statistics;
                }

                let hRank = "", aRank = "";
                let hForm = "", aForm = "";
                if(standData.response && standData.response.length > 0) {
                    const table = standData.response[0].league.standings[0];
                    const hTeam = table.find(t => t.team.name === hName);
                    const aTeam = table.find(t => t.team.name === aName);
                    const formatForm = (f) => f.split('').map(c => `<span class="form-${c.toLowerCase()}">${c}</span>`).join('');
                    if(hTeam) { hRank = `<span class="rank-badge">[${hTeam.rank}]</span>`; hForm = `<span class="form-badge">${formatForm(hTeam.form.slice(-5))}</span>`; }
                    if(aTeam) { aRank = `<span class="rank-badge">[${aTeam.rank}]</span>`; aForm = `<span class="form-badge">${formatForm(aTeam.form.slice(-5))}</span>`; }
                    
                    // UPDATE CARD RANKS
                    if(hTeam) document.getElementById(`rank-h-${id}`).innerText = `[#${hTeam.rank}]`;
                    if(aTeam) document.getElementById(`rank-a-${id}`).innerText = `[#${aTeam.rank}]`;
                }

                const getStat = (arr, type) => { 
                    const i = arr.find(s => s.type === type || s.type === type.replace(" ", "")); 
                    if(i && i.value) return parseFloat(i.value);
                    return 0; 
                };

                let hSoT = getStat(hStats, "Shots on Goal");
                let aSoT = getStat(aStats, "Shots on Goal");
                let hTotal = getStat(hStats, "Total Shots");
                let aTotal = getStat(aStats, "Total Shots");
                let hCorn = getStat(hStats, "Corner Kicks");
                let aCorn = getStat(aStats, "Corner Kicks");
                
                // --- NEW IMPROVED METRICS ---
                const vColor = hPercent > 65 ? "var(--green)" : (aPercent > 65 ? "var(--purple)" : "var(--gold)");
                const verdict = hPercent > 65 ? "Home Siege" : (aPercent > 65 ? "Away Siege" : "0-0 Stalemate");
                const trendBadge = ""; 
                const synthBadge = isSynthetic ? "<span class='synth-badge'>[SYNTH]</span>" : "";
                const neighborHtml = "";
                const weatherHtml = "";
                const subImpactHtml = "";
                const cornerWatch = "";
                const timeWarning = "";
                const xgHTML = hxG > 0 ? `<div class="stat-bar"><span>xG</span><span class="stat-val">${hxG.toFixed(2)} - ${axG.toFixed(2)}</span></div>` : "";
                const tipsHTML = "";
                const oddsHTML = "";
                const newConf = Math.max(hPercent, aPercent);

                // Final assembly with Corner Watch
                statBox.innerHTML = `
                    <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:${vColor}; font-size:1rem;">${verdict}${trendBadge} ${synthBadge}</div>
                    ${h2hHtml}
                    <div class="gauge-labels">
                        <span>${hName} ${hRank} ${hForm} (${hPercent}%)</span>
                        <span>${aName} ${aRank} ${aForm} (${aPercent}%)</span>
                    </div>
                    <div class="gauge-container"><div class="gauge-home" style="width:${hPercent}%"></div><div class="gauge-away" style="width:${aPercent}%"></div></div>
                    ${xgHTML}
                    <div class="stat-bar"><span>Shots (Total)</span><span class="stat-val">${hTotal} (${hSoT}) - ${aTotal} (${aSoT})</span></div>
                    <div class="stat-bar"><span>Corners</span><span class="stat-val">${hCorn} - ${aCorn}</span></div>
                    <button class="copy-btn" onclick="copyTip('${hName}', '${aName}', '${verdict}', ${newConf})">üìã Copy Report</button>
                `;
                
                const predText = document.getElementById(`pred-text-${id}`);
                if(predText) { predText.innerText = verdict; predText.style.color = vColor; }
                
                // Recalculate counts whenever a card is enriched/updated
                calculateStrategyCounts();
                
            } catch(e) { 
                console.error("Analysis Error:", e);
                statBox.innerHTML = "<div style='color:#da3633;'>Error analyzing.</div>"; 
            }
            if(btn) btn.innerText = "‚ö° Analyze";
        }

        async function checkPlayers(btn, id) {
            trackAPI(1);
            const area = document.getElementById(`p-${id}`);
            
            // TOGGLE LOGIC
            if(area.style.display === 'block') {
                area.style.display = 'none';
                btn.innerText = "üïµÔ∏è Check Players";
                return;
            }
            
            area.style.display = 'block';
            btn.innerText = "‚ùå Close Players";
            area.innerHTML = "<div style='color:#888; text-align:center;'>Scanning Players...</div>";

            try {
                const res = await fetch(`https://v3.football.api-sports.io/fixtures/players?fixture=${id}`, { headers: { "x-rapidapi-key": API_KEY } });
                const data = await res.json();
                
                let players = [];
                if(data.response && data.response.length > 0) {
                    data.response.forEach(t => t.players.forEach(p => {
                        const s = p.statistics[0];
                        // THREAT RATING (Goals/Assists only)
                        const hts = (s.shots.on || 0) * 3 + (s.shots.total - (s.shots.on||0) || 0) * 1 + (s.passes.key || 0) * 2 + (s.dribbles.success || 0) * 0.5;
                        const rating = Math.min(10, hts).toFixed(1);

                        if (hts > 2) {
                            players.push({
                                name: p.player.name,
                                team: t.team.name,
                                rating: rating,
                                rawScore: hts,
                                details: `${s.shots.on||0} SoT, ${s.passes.key||0} KP`
                            });
                        }
                    }));
                }

                players.sort((a, b) => b.rawScore - a.rawScore);
                
                let html = "";
                if (players.length === 0) {
                    html = "<div style='text-align:center; color:#888;'>No significant player stats yet.</div>";
                } else {
                    players.slice(0, 5).forEach(p => { 
                        let badgeClass = "rate-med";
                        let typeText = "Threat";
                        if (p.rawScore >= 8) { badgeClass = "rate-high"; typeText = "üî• GOAL THREAT"; }
                        else if (p.rawScore >= 5) { badgeClass = "rate-med"; typeText = "üÖ∞Ô∏è CREATOR"; }

                        html += `
                            <div class="player-row">
                                <div>
                                    <div class="player-name">${p.name} <span style="font-size:0.7rem; color:#666">(${p.team})</span></div>
                                    <div class="player-detail">${p.details}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div class="player-rating ${badgeClass}">${typeText}</div>
                                    <div style="font-size:0.7rem; color:#888; margin-top:2px;">RATING: ${p.rating}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                area.innerHTML = html;

            } catch(e) { area.innerHTML = "<div style='color:#da3633; text-align:center;'>Error checking players.</div>"; }
        }

        // --- NEW CARD SCANNER (ELITE ONLY) ---
        async function scanGlobalCards(btn) {
            btn.innerText = "‚ö†Ô∏è Scanning Elite Leagues...";
            const area = document.getElementById('cardContent');
            area.innerHTML = "<div style='text-align:center; padding:20px; color:#888'>Scanning player discipline across Elite matches... This may take a moment.</div>";
            
            // ELITE FILTER
            const liveIDs = allMatches
                .filter(m => ELITE_IDS.includes(m.league.id))
                .map(m => m.fixture.id);

            if(liveIDs.length === 0) {
                area.innerHTML = "<div style='text-align:center; padding:20px; color:#da3633'>No live Elite matches to scan.</div>";
                btn.innerText = "‚ö†Ô∏è SCAN GLOBAL CARD RISKS";
                return;
            }

            let riskPlayers = [];
            
            // BATCH REQUESTS
            for (let i = 0; i < liveIDs.length; i += 5) {
                const batch = liveIDs.slice(i, i + 5);
                const promises = batch.map(id => 
                    fetch(`https://v3.football.api-sports.io/fixtures/players?fixture=${id}`, { headers: { "x-rapidapi-key": API_KEY } })
                    .then(r => r.json())
                    .catch(e => null)
                );
                trackAPI(batch.length);
                
                const results = await Promise.all(promises);
                const pBets = getMarkedPlayers();
                
                results.forEach(data => {
                    if(data && data.response) {
                        // FIND MATCH & REF INFO
                        const match = allMatches.find(m => m.fixture.id === data.parameters.fixture);
                        let refName = match && match.fixture.referee ? match.fixture.referee.split(',')[0] : "Unknown Ref";
                        let refStrict = "";
                        
                        // CALCULATE LIVE REF STRICTNESS
                        if(match && match.events) {
                            const fouls = match.events.filter(e => e.type === "Foul").length || 1; // avoid /0
                            const cards = match.events.filter(e => e.type === "Card").length || 0;
                            const ratio = cards / fouls;
                            if (ratio > 0.25) refStrict = `<div class="ref-badge ref-strict">üëÆ STRICT (${Math.round(ratio*100)}% Card Rate)</div>`;
                            else if (ratio < 0.1) refStrict = `<div class="ref-badge ref-lenient">üí§ LENIENT (${Math.round(ratio*100)}% Card Rate)</div>`;
                            else refStrict = `<div class="ref-badge">‚öñÔ∏è NORMAL (${Math.round(ratio*100)}% Card Rate)</div>`;
                        }

                        data.response.forEach(t => t.players.forEach(p => {
                            const s = p.statistics[0];
                            if (s.fouls.committed >= 2 && !s.cards.yellow && !s.cards.red) {
                                const time = match ? match.fixture.status.elapsed + "'" : "Live";
                                const uid = `${data.parameters.fixture}-${p.player.id}`;
                                const isMarked = pBets.includes(uid);
                                
                                p.statistics[0].subbed_off = p.player.subbed_off || (s.sub === "out"); // Defensive check
                                riskPlayers.push({
                                    uid: uid,
                                    name: p.player.name,
                                    team: t.team.name,
                                    time: time,
                                    fouls: s.fouls.committed,
                                    ref: refName,
                                    refBadge: refStrict,
                                    isMarked: isMarked,
                                    isSubbed: s.games.minutes === null || (s.games.sub && s.games.sub === "out") || false,
                                    pos: s.games.position || ""
                                });
                            }
                        }));
                    }
                });
            }

            riskPlayers.sort((a, b) => b.fouls - a.fouls);

            let html = "";
            if(riskPlayers.length === 0) {
                html = "<div style='text-align:center; padding:20px; color:#888'>No high-risk players found in Elite leagues yet.</div>";
            } else {
                riskPlayers.forEach(p => {
                    const activeClass = p.isMarked ? 'active' : '';
                    const markClass = p.isMarked ? 'marked' : '';
                    const subbedClass = p.isSubbed ? 'subbed-off' : '';
                    const tick = p.isMarked ? '‚úì' : '';
                    const subLabel = p.isSubbed ? ' <span style="color:var(--red); font-size:0.7rem;">[SUBBED OFF]</span>' : '';
                    const posLabel = p.pos ? `<span class="pos-badge" style="color:var(--cyan); border:1px solid var(--cyan); background:rgba(63, 185, 80, 0.1); padding:1px 6px; font-size:0.7rem; margin-left:5px;">${p.pos}</span>` : '';
                    
                    const foulClass = p.fouls === 2 ? 'warning' : '';
                    
                    html += `
                        <div class="card-table-row ${markClass} ${subbedClass}">
                            <div class="card-check-btn ${activeClass}" onclick="togglePlayerBet('${p.uid}', this)">${tick}</div>
                            <div class="card-player-info">
                                <div class="card-player-name">${p.name}${subLabel} ${posLabel} <span style="font-weight:normal; color:#666">(${p.team})</span></div>
                                <div class="card-match-info">${p.time} ‚Ä¢ Ref: ${p.ref}</div>
                                ${p.refBadge}
                            </div>
                            <div class="card-foul-badge ${foulClass}">${p.fouls} Fouls</div>
                        </div>
                    `;
                });
            }
            
            area.innerHTML = html;
            btn.innerText = "‚ö†Ô∏è SCAN GLOBAL CARD RISKS";
        }

        function getMarkedPlayers() { return JSON.parse(localStorage.getItem('cardBets') || "[]"); }
        function togglePlayerBet(uid, el) {
            let pBets = getMarkedPlayers();
            if(pBets.includes(uid)) {
                pBets = pBets.filter(b => b !== uid);
                el.classList.remove('active');
                el.innerText = "";
                el.parentElement.classList.remove('marked');
            } else {
                pBets.push(uid);
                el.classList.add('active');
                el.innerText = "‚úì";
                el.parentElement.classList.add('marked');
            }
            localStorage.setItem('cardBets', JSON.stringify(pBets));
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW registration failed:', err));
            });
        }
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        if (installBtn) {
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'block'; });
            installBtn.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; installBtn.style.display = 'none'; } });
        }
    </script>
</body>
</html>
