<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Final Third</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --green: #2ea043; --gold: #d29922; --red: #da3633; --purple: #a371f7; --blue: #1f6feb; --text: #c9d1d9; --cyan: #3fb950; }
        body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 16px; padding-bottom: 120px; }
        header { border-bottom: 1px solid #30363d; padding-bottom: 15px; margin-bottom: 15px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.4rem; color: var(--blue); display: flex; align-items: center; gap: 10px; }
        .api-badge { background: #21262d; border: 1px solid #30363d; color: #8b949e; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .help-btn { background: #21262d; border: 1px solid #30363d; color: var(--gold); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; }
        .pilot-btn { background: #21262d; border: 1px solid #30363d; color: #888; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .pilot-btn.active { background: rgba(46, 160, 67, 0.2); border-color: var(--green); color: var(--green); }
        .pilot-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .pilot-btn.active .pilot-dot { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .nav-tabs { display: flex; gap: 8px; margin-top: 15px; overflow-x: auto; }
        .nav-tab { flex: 1; text-align: center; padding: 10px; background: #21262d; border-radius: 8px; border: 1px solid #30363d; color: #888; cursor: pointer; font-size: 0.85rem; white-space: nowrap; }
        .nav-tab.active { background: var(--blue); color: white; border-color: var(--blue); }
        select { width: 100%; padding: 12px; background: #21262d; color: white; border: 1px solid #30363d; border-radius: 8px; margin-top: 10px; appearance: none; }
        .chip-container { display: flex; gap: 8px; overflow-x: auto; margin: 15px 0; scrollbar-width: none; }
        .chip { padding: 6px 12px; border-radius: 20px; background: #21262d; border: 1px solid #30363d; color: #888; font-size: 0.8rem; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .chip.active { background: #d29922; color: #0d1117; border-color: #d29922; }
        .match-card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; }
        .match-card.pulse-home { animation: pulse-green 2s infinite; border-color: var(--green); }
        .match-card.pulse-away { animation: pulse-purple 2s infinite; border-color: var(--purple); }
        .score-row { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
        .score-box { background: #21262d; padding: 8px 14px; border-radius: 8px; font-family: monospace; font-weight: bold; }
        .team-name { font-size: 1rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .rank-on-card { color: var(--gold); font-size: 0.8rem; font-family: monospace; }
        .analysis-box { background: #1c1c1c; border: 1px solid var(--purple); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .bet365-btn { flex: 1; background: #00703c; color: white; padding: 10px; border-radius: 8px; text-align: center; text-decoration: none; font-weight: bold; }
        .mark-btn { background: #21262d; border: 1px solid #30363d; color: #888; border-radius: 8px; padding: 0 15px; cursor: pointer; }
        .mark-btn.active { background: var(--green); color: white; }
        .scan-btn { position: fixed; bottom: 30px; left: 5%; width: 90%; background: var(--blue); color: white; padding: 16px; border-radius: 16px; font-weight: bold; border: none; z-index: 100; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; overflow-y: auto; }
        .modal-content { background: #161b22; margin: 10% auto; padding: 20px; width: 85%; border-radius: 12px; border: 1px solid #30363d; }
        details { margin-bottom: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; border: 1px solid #30363d; }
        summary { cursor: pointer; font-weight: bold; color: var(--blue); outline: none; }
        .hist-date-row { display: flex; justify-content: space-between; padding: 10px; background: #21262d; border-radius: 8px; margin-bottom: 8px; }
        .val-good { color: var(--green); font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div class="top-row">
            <h1><img src="target_PNG26.png" width="28"> The Final Third</h1>
            <div class="header-right">
                <div id="apiCounter" class="api-badge">API: 0</div>
                <button class="help-btn" onclick="openHelp()">?</button>
            </div>
        </div>
        <button id="pilotBtn" class="pilot-btn" onclick="togglePilot()"><div class="pilot-dot"></div> Auto-Pilot</button>
        <div class="nav-tabs">
            <div id="tabLive" class="nav-tab active" onclick="switchTab('live')">üî¥ Live Hunt</div>
            <div id="tabSched" class="nav-tab" onclick="switchTab('sched')">üìÖ Schedule</div>
            <div id="tabCards" class="nav-tab" onclick="switchTab('cards')">üü® Card Watch</div>
            <div id="tabHist" class="nav-tab" onclick="switchTab('hist')">üìú History</div>
        </div>
        <select id="filterSelect" onchange="applyFilter()">
            <option value="elite">üá¨üáß UK & Elite</option>
            <option value="europe">üá™üá∫ Europe</option>
            <option value="world">üåé World Scan</option>
        </select>
    </header>

    <div id="liveView">
        <div class="chip-container">
            <div class="chip active" onclick="setStrategy('all', this)">üåç All</div>
            <div class="chip" onclick="setStrategy('losing', this)">ü©∏ Fav Losing</div>
            <div class="chip" onclick="setStrategy('drought', this)">‚è≥ Drought</div>
            <div class="chip" onclick="setStrategy('red', this)">üü• Red Card</div>
            <div class="chip" onclick="setStrategy('late', this)">üß® Late</div>
        </div>
        <div id="content"></div>
        <button class="scan-btn" onclick="runScan()" id="mainBtn">üéØ SCAN MARKETS</button>
    </div>

    <div id="schedView" style="display:none;"><div id="schedContent"></div></div>
    <div id="cardView" style="display:none;">
        <button class="card-scan-btn" style="width:100%; background:var(--red); color:white; padding:14px; border-radius:8px; border:none; margin-bottom:15px; font-weight:bold;" onclick="scanGlobalCards(this)">‚ö†Ô∏è SCAN GLOBAL CARD RISKS</button>
        <div id="cardContent"></div>
    </div>
    <div id="histView" style="display:none;"><div id="histContent"></div></div>

    <div id="helpModal" class="modal" onclick="closeHelp(event)">
        <div class="modal-content">
            <h2 style="color:var(--blue)">User Manual</h2>
            <details open><summary>üî¥ Live & Sniper</summary><p>Scans 60-85m games. <b>Drought</b> logic finds games with >50m since the last goal.</p></details>
            <details><summary>üèÜ Elite Leagues</summary><p>PL, Championship, La Liga, Bundesliga, Serie A, Ligue 1, Eredivisie, Primeira Liga, MLS, SPL (Scotland), Saudi Pro League.</p></details>
            <details><summary>üí° Icons</summary><p>üß¨ Synth Stats, üëÆ Strict Ref, üî• Siege Momentum.</p></details>
            <button onclick="document.getElementById('helpModal').style.display='none'" style="width:100%; padding:12px; margin-top:10px; background:#333; color:white; border:none; border-radius:8px;">Close</button>
        </div>
    </div>

    <script>
        const API_KEY = "0f29a2f96e9dd4231cee515cc5ec52b0";
        const ELITE_IDS = [39, 40, 45, 48, 179, 180, 140, 78, 135, 61, 88, 94, 144, 2, 3, 529, 556, 81, 143, 307, 253];
        let allMatches = [], pilotMode = false, pilotInterval, alertedGames = new Set(), currentStrategy = 'all', momentumHistory = {};

        const trackAPI = (count) => {
            let current = parseInt(localStorage.getItem('apiCount') || "0") + count;
            localStorage.setItem('apiCount', current);
            document.getElementById('apiCounter').innerText = `API: ${current}`;
        };

        const switchTab = (tab) => {
            ['liveView','schedView','cardView','histView'].forEach(v => document.getElementById(v).style.display = 'none');
            document.getElementById(tab + 'View').style.display = 'block';
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            if(tab === 'sched') loadSchedule();
            if(tab === 'hist') renderHistory();
        };

        async function runScan(isAuto = false) {
            trackAPI(1);
            if(!isAuto) document.getElementById('content').innerHTML = "<p style='text-align:center; margin-top:50px'>Scanning...</p>";
            try {
                const res = await fetch("https://v3.football.api-sports.io/fixtures?live=all", { headers: { "x-rapidapi-key": API_KEY } });
                const data = await res.json();
                allMatches = data.response.filter(m => m.fixture.status.elapsed >= 60 && m.fixture.status.elapsed <= 85);
                applyFilter(isAuto);
            } catch(e) { console.error(e); }
        }

        function applyFilter(isAuto = false) {
            const mode = document.getElementById('filterSelect').value;
            const content = document.getElementById('content');
            content.innerHTML = "";
            const filtered = allMatches.filter(m => {
                if (mode === 'elite' && !ELITE_IDS.includes(m.league.id)) return false;
                if (currentStrategy === 'losing') return m.goals.home < m.goals.away;
                if (currentStrategy === 'late') return m.fixture.status.elapsed >= 80;
                if (currentStrategy === 'drought') {
                    const lastGoal = m.events?.filter(e => e.type === 'Goal').pop()?.time.elapsed || 0;
                    return (m.goals.home + m.goals.away > 0) && (m.fixture.status.elapsed - lastGoal > 50);
                }
                return true;
            });
            filtered.forEach(m => createCard(m));
            if(mode === 'elite') enrichEliteMatches(filtered);
        }

        function createCard(m) {
            const div = document.createElement('div');
            div.className = 'match-card';
            div.id = `card-${m.fixture.id}`;
            div.innerHTML = `
                <div style="font-size:0.75rem; color:#888; margin-bottom:8px;">${m.league.name}</div>
                <div class="score-row">
                    <div style="flex:1; text-align:right;"><span id="rank-h-${m.fixture.id}" class="rank-on-card"></span> ${m.teams.home.name}</div>
                    <div class="score-box">${m.goals.home}-${m.goals.away}</div>
                    <div style="flex:1; text-align:left;">${m.teams.away.name} <span id="rank-a-${m.fixture.id}" class="rank-on-card"></span></div>
                </div>
                <div style="text-align:center; font-size:0.8rem; color:#666;">${m.fixture.status.elapsed}' Played</div>
                <div id="stats-${m.fixture.id}" class="analysis-box" style="display:none; text-align:center; color:#888;">Loading Stats...</div>
                <div class="btn-row">
                    <a href="https://www.bet365.com" class="bet365-btn">Bet365</a>
                    <button class="mark-btn" onclick="this.classList.toggle('active')">üìå</button>
                    <button class="mark-btn" onclick="checkPlayers(this, ${m.fixture.id})">üïµÔ∏è</button>
                </div>
                <div id="p-${m.fixture.id}" class="player-box"></div>
            `;
            document.getElementById('content').appendChild(div);
        }

        async function enrichEliteMatches(matches) {
            for (const m of matches) {
                const box = document.getElementById(`stats-${m.fixture.id}`);
                box.style.display = 'block';
                await deepAnalyze(m.fixture.id, m.league.id, m.league.season);
                await new Promise(r => setTimeout(r, 450));
            }
        }

        async function deepAnalyze(id, lid, season) {
            trackAPI(3);
            try {
                const [sRes, oRes, stRes] = await Promise.all([
                    fetch(`https://v3.football.api-sports.io/fixtures/statistics?fixture=${id}`, { headers: { "x-rapidapi-key": API_KEY } }),
                    fetch(`https://v3.football.api-sports.io/odds/live?fixture=${id}`, { headers: { "x-rapidapi-key": API_KEY } }),
                    fetch(`https://v3.football.api-sports.io/standings?league=${lid}&season=${season}`, { headers: { "x-rapidapi-key": API_KEY } })
                ]);
                const stats = await sRes.json();
                const odds = await oRes.json();
                const stand = await stRes.json();
                
                const box = document.getElementById(`stats-${id}`);
                if (!stats.response[0]) { box.innerHTML = "No live stats available."; return; }
                
                const hStats = stats.response[0].statistics;
                const aStats = stats.response[1].statistics;
                const getS = (arr, t) => parseInt(arr.find(x => x.type === t)?.value || 0);

                const hPress = (getS(hStats, "Shots on Goal") * 5) + (getS(hStats, "Corner Kicks") * 2);
                const aPress = (getS(aStats, "Shots on Goal") * 5) + (getS(aStats, "Corner Kicks") * 2);
                const hPct = Math.round((hPress / (hPress + aPress || 1)) * 100);

                box.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Pressure: ${hPct}%</span><span>${100-hPct}%</span>
                    </div>
                    <div style="height:8px; background:#333; border-radius:4px; overflow:hidden; display:flex;">
                        <div style="width:${hPct}%; background:var(--green)"></div>
                        <div style="width:${100-hPct}%; background:var(--purple)"></div>
                    </div>
                `;
            } catch(e) { console.error(e); }
        }

        function togglePilot() {
            pilotMode = !pilotMode;
            const btn = document.getElementById('pilotBtn');
            btn.classList.toggle('active', pilotMode);
            btn.innerHTML = pilotMode ? `<div class="pilot-dot"></div> ON (5m)` : `<div class="pilot-dot"></div> Auto-Pilot`;
            if(pilotMode) { runScan(true); pilotInterval = setInterval(() => runScan(true), 300000); }
            else clearInterval(pilotInterval);
        }

        function openHelp() { document.getElementById('helpModal').style.display = 'block'; }
        function closeHelp(e) { if(e.target.id === 'helpModal') e.target.style.display = 'none'; }
        function setStrategy(s, el) { 
            currentStrategy = s; 
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); 
            el.classList.add('active'); 
            applyFilter(); 
        }
    </script>
</body>
</html>
